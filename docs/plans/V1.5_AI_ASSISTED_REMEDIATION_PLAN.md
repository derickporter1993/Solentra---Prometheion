# v1.5 AI-Assisted Remediation Implementation Plan

**Version**: 1.0
**Status**: Planning
**Target Release**: Q2 2025 (April-June)
**Last Updated**: 2026-01-09

---

## Executive Summary

This document outlines the detailed implementation plan for Elaro v1.5 AI-Assisted Remediation features. The release focuses on reducing time-to-remediation from hours to minutes by leveraging AI to explain violations, suggest fixes, and integrate with external ticketing systems.

### v1.5 Features Overview

| Feature | Description | Effort |
|---------|-------------|--------|
| [AI Change Explanations](#1-ai-change-explanations) | GPT/Claude integration to explain compliance violations in plain English | 3 weeks |
| [Suggested Fixes](#2-suggested-fixes) | Auto-generate remediation steps with copy-paste Apex/metadata | 4 weeks |
| [Jira Integration](#3-jira-integration) | Auto-create tickets for high-risk changes with bidirectional sync | 2 weeks |
| [Compliance Report Scheduler](#4-compliance-report-scheduler) | Scheduled jobs that email compliance reports (daily/weekly/monthly) | 1 week |
| [Mobile Alerts](#5-mobile-alerts) | Push notifications to Salesforce Mobile App for critical events | 2 weeks |

**Total Estimated Effort**: 12 weeks

---

## Existing Infrastructure Analysis

### Current AI Capabilities

The codebase already has substantial AI infrastructure:

| Component | File | Capability |
|-----------|------|------------|
| `ElaroComplianceCopilotService` | `classes/ElaroComplianceCopilotService.cls` | Claude API integration with caching |
| `ElaroComplianceCopilot` | `classes/ElaroComplianceCopilot.cls` | Natural language Q&A interface |
| `ElaroReasoningEngine` | `classes/ElaroReasoningEngine.cls` | Violation explanation with audit trail |
| `ElaroAIRiskPredictor` | `classes/ElaroAIRiskPredictor.cls` | Risk scoring and prediction |

### Current Integration Patterns

| Integration | Named Credential | Pattern |
|-------------|-----------------|---------|
| Slack | `Slack_Webhook` | Queueable + webhook |
| Teams | `Teams_Webhook` | Queueable + webhook |
| Claude API | `Elaro_Claude_API` | HTTP callout with caching |
| ServiceNow | `ServiceNow_API` | @future callouts |

### Current Scheduling

| Scheduler | File | Purpose |
|-----------|------|---------|
| `WeeklyScorecardScheduler` | `classes/WeeklyScorecardScheduler.cls` | Weekly compliance scorecards |
| `ElaroDailyDigest` | `classes/ElaroDailyDigest.cls` | Daily compliance summary |

---

## Feature 1: AI Change Explanations

### Problem Statement

Users don't understand WHY a change is flagged as high-risk. Current alerts show raw technical data without context.

### Solution

Integrate Claude API to generate plain-English explanations of compliance violations with framework-specific citations.

### Example Output

```
ğŸ”´ High-Risk Change Detected

Change: Permission Set "Financial_Data_Access" modified
Risk Score: 8.7/10

AI Explanation:
This change grants 45 users "Modify All Data" permission, which violates
the principle of least privilege (NIST 800-53 AC-6). These users can now
access, modify, or delete ANY data in the org, including PHI/PII.

Compliance Impact:
- HIPAA: Fails "minimum necessary" access requirement (Â§164.514(d))
- SOC 2: Fails logical access controls (CC6.1)
- SOX: Fails segregation of duties (Section 404)

Suggested Fix:
Create a custom permission set with granular access to only:
- Financial_Transactions__c (Read/Edit)
- Account.AnnualRevenue (Read)
Instead of org-wide "Modify All Data".
```

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI Change Explanation Flow                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Platform     â”‚â”€â”€â”€â”€â–¶â”‚ ElaroEventâ”‚â”€â”€â”€â”€â–¶â”‚ AIExplanation    â”‚ â”‚
â”‚  â”‚ Event        â”‚     â”‚ Processor       â”‚     â”‚ Service          â”‚ â”‚
â”‚  â”‚ (trigger)    â”‚     â”‚                 â”‚     â”‚                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚           â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ ElaroCompliance â”‚ â”‚
â”‚  â”‚ Cache        â”‚â—€â”€â”€â”€â”€â”‚ Rate Limiter    â”‚â”‚ CopilotService        â”‚ â”‚
â”‚  â”‚ (Platform    â”‚     â”‚ (10 req/5min)   â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚  Cache)      â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                           â”‚ Claude API            â”‚ â”‚
â”‚                                           â”‚ (callout:Elaro_ â”‚ â”‚
â”‚                                           â”‚  Claude_API)          â”‚ â”‚
â”‚                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Tasks

#### Phase 1: Core Explanation Service (Week 1)

| Task | File | Description |
|------|------|-------------|
| 1.1 | `classes/AIExplanationService.cls` | Create main service class |
| 1.2 | `classes/AIExplanationServiceTest.cls` | Test class with 95%+ coverage |
| 1.3 | Update `ElaroComplianceCopilotService.cls` | Add explanation prompts |
| 1.4 | `objects/Elaro_AI_Explanation__c.object-meta.xml` | Store explanations for audit |

**AIExplanationService.cls Specification:**

```apex
public with sharing class AIExplanationService {

    // Public methods
    @AuraEnabled
    public static ExplanationResult explainViolation(String gapId);

    @AuraEnabled
    public static ExplanationResult explainChange(String auditTrailEntryId);

    @AuraEnabled
    public static List<ExplanationResult> batchExplainViolations(List<String> gapIds);

    // Inner classes
    public class ExplanationResult {
        @AuraEnabled public String gapId;
        @AuraEnabled public String plainEnglishExplanation;
        @AuraEnabled public String technicalExplanation;
        @AuraEnabled public Decimal confidence;
        @AuraEnabled public List<ComplianceImpact> impacts;
        @AuraEnabled public List<String> suggestedActions;
        @AuraEnabled public Datetime generatedAt;
        @AuraEnabled public String modelUsed;
    }

    public class ComplianceImpact {
        @AuraEnabled public String framework;
        @AuraEnabled public String controlId;
        @AuraEnabled public String citation;
        @AuraEnabled public String impact;
    }
}
```

#### Phase 2: Framework-Specific Prompts (Week 2)

| Task | File | Description |
|------|------|-------------|
| 2.1 | `classes/AIExplanationPromptBuilder.cls` | Build framework-specific prompts |
| 2.2 | `customMetadata/AI_Explanation_Template__mdt.* ` | Store prompt templates per framework |
| 2.3 | Update each framework module | Add citation mappings |

**Prompt Template Structure:**

```yaml
# AI_Explanation_Template__mdt
Framework__c: HIPAA
Prompt_Template__c: |
  You are analyzing a Salesforce configuration change for HIPAA compliance.

  Change Details:
  {change_summary}

  Relevant HIPAA Regulations:
  - Â§164.312(a)(1): Access Control - Implement technical policies to limit access
  - Â§164.312(b): Audit Controls - Record and examine activity in systems with ePHI
  - Â§164.514(d): Minimum Necessary - Use or disclose only minimum PHI needed

  Analyze this change and explain:
  1. What compliance risk does this introduce?
  2. Which specific HIPAA sections are affected?
  3. What is the recommended remediation?

  Format your response as JSON with fields:
  - risk_summary: string
  - affected_sections: array of {section_id, section_title, impact}
  - remediation_steps: array of strings
  - risk_score: number (1-10)
  - confidence: number (0-1)
```

#### Phase 3: LWC Integration (Week 3)

| Task | File | Description |
|------|------|-------------|
| 3.1 | `lwc/aiExplanationCard/*` | Display explanation in card format |
| 3.2 | `lwc/complianceGapList/*` | Add "Explain" button to gap list |
| 3.3 | `lwc/elaroCopilot/*` | Integrate explanation into copilot chat |
| 3.4 | Update `elaroDashboard` | Add explanation panel |

**LWC Component: aiExplanationCard**

```javascript
// aiExplanationCard.js
import { LightningElement, api, wire } from 'lwc';
import explainViolation from '@salesforce/apex/AIExplanationService.explainViolation';

export default class AiExplanationCard extends LightningElement {
    @api gapId;
    @api recordId;

    explanation;
    isLoading = false;
    error;

    @wire(explainViolation, { gapId: '$gapId' })
    wiredExplanation({ error, data }) {
        if (data) {
            this.explanation = data;
            this.isLoading = false;
        } else if (error) {
            this.error = error.body.message;
            this.isLoading = false;
        }
    }

    handleRefresh() {
        this.isLoading = true;
        // Force refresh from API
    }

    handleCopy() {
        // Copy explanation to clipboard
    }

    handleExport() {
        // Export as PDF/Markdown
    }
}
```

### Custom Objects & Fields

**Elaro_AI_Explanation__c**

| Field | Type | Description |
|-------|------|-------------|
| `Gap__c` | Lookup(Compliance_Gap__c) | Related gap |
| `Audit_Entry_Id__c` | Text(18) | SetupAuditTrail entry |
| `Plain_English__c` | Long Text(32000) | Plain English explanation |
| `Technical_Explanation__c` | Long Text(32000) | Technical details |
| `Confidence__c` | Percent | AI confidence |
| `Model_Used__c` | Text(50) | Claude model version |
| `Prompt_Tokens__c` | Number | Token usage tracking |
| `Completion_Tokens__c` | Number | Token usage tracking |
| `Framework_Impacts__c` | Long Text(10000) | JSON of framework impacts |
| `Generated_At__c` | Datetime | Timestamp |
| `Generated_By__c` | Lookup(User) | Requesting user |

### Testing Requirements

| Test Class | Coverage Target | Key Scenarios |
|------------|-----------------|---------------|
| `AIExplanationServiceTest` | 95% | Happy path, error handling, rate limiting |
| `AIExplanationPromptBuilderTest` | 95% | All frameworks, edge cases |
| `aiExplanationCard.test.js` | 90% | Loading, error, success states |

### Dependencies

- Claude API Named Credential (existing: `Elaro_Claude_API`)
- Platform Cache partition (existing: `local.ElaroCache`)
- `Compliance_Gap__c` object (existing)

### Success Metrics

| Metric | Target |
|--------|--------|
| Explanation accuracy | >90% user satisfaction |
| Response time | <5 seconds |
| Cache hit rate | >50% |
| Token cost per explanation | <$0.05 |

---

## Feature 2: Suggested Fixes

### Problem Statement

Users know WHAT's wrong but not HOW to fix it. They need actionable, copy-paste remediation steps.

### Solution

Auto-generate remediation steps with ready-to-use Apex code, metadata changes, and step-by-step instructions.

### Example Output

```
Suggested Fix for: "127 users with Modify All Data"

Step 1: Create Custom Permission Set
Run this Apex to create a granular permission set:

    PermissionSet ps = new PermissionSet(
        Name = 'Financial_Data_Limited',
        Label = 'Financial Data (Limited Access)'
    );
    insert ps;

    ObjectPermissions op = new ObjectPermissions(
        ParentId = ps.Id,
        SObjectType = 'Financial_Transactions__c',
        PermissionsRead = true,
        PermissionsEdit = true,
        PermissionsCreate = false,
        PermissionsDelete = false
    );
    insert op;

Step 2: Reassign Users
Export users with "Modify All Data":
Reports â†’ New Report â†’ Users â†’ Filter: PermissionsModifyAllData = true

Step 3: Remove "Modify All Data"
For each user, remove from "Modify All Data" profile/permission set and
assign new "Financial_Data_Limited" permission set.

Estimated Time: 2-3 hours (depending on # of users)
Compliance Impact: Reduces risk score by 20 points
```

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Suggested Fixes Flow                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Compliance   â”‚â”€â”€â”€â”€â–¶â”‚ FixSuggestion   â”‚â”€â”€â”€â”€â–¶â”‚ CodeGenerator    â”‚ â”‚
â”‚  â”‚ Gap          â”‚     â”‚ Service         â”‚     â”‚ Service          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚                       â”‚           â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚           â”‚
â”‚                   â”‚ Fix Template Library    â”‚          â”‚           â”‚
â”‚                   â”‚ (Custom Metadata)       â”‚          â”‚           â”‚
â”‚                   â”‚                         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                   â”‚ - Permission fixes      â”‚                      â”‚
â”‚                   â”‚ - Profile fixes         â”‚                      â”‚
â”‚                   â”‚ - Sharing rule fixes    â”‚                      â”‚
â”‚                   â”‚ - Field tracking fixes  â”‚                      â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                â”‚                                    â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                   â”‚ Validation Engine       â”‚                      â”‚
â”‚                   â”‚ (Validate before apply) â”‚                      â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Tasks

#### Phase 1: Fix Template Library (Week 1)

| Task | File | Description |
|------|------|-------------|
| 1.1 | `customMetadata/Remediation_Template__mdt.*` | Define fix templates |
| 1.2 | `classes/RemediationTemplateService.cls` | Template management |
| 1.3 | `classes/RemediationTemplateServiceTest.cls` | Test coverage |

**Remediation_Template__mdt Structure:**

| Field | Type | Example |
|-------|------|---------|
| `Gap_Category__c` | Picklist | `MODIFY_ALL_DATA`, `OWD_PUBLIC`, `NO_AUDIT_TRAIL` |
| `Framework__c` | Text | `HIPAA,SOC2,NIST` (comma-separated) |
| `Template_Type__c` | Picklist | `APEX_SCRIPT`, `METADATA_XML`, `STEP_BY_STEP` |
| `Template_Code__c` | Long Text | Apex/XML template with placeholders |
| `Placeholders__c` | Long Text | JSON: `{"user_id": "Id", "permission_set": "String"}` |
| `Estimated_Time__c` | Text | "2-3 hours" |
| `Risk_Reduction__c` | Number | 20 (points) |
| `Prerequisites__c` | Long Text | What must be true before applying |
| `Rollback_Script__c` | Long Text | How to undo the fix |

**Example Templates:**

```yaml
# Remove Modify All Data
Gap_Category__c: MODIFY_ALL_DATA
Template_Type__c: APEX_SCRIPT
Template_Code__c: |
  // Step 1: Query users with Modify All Data
  List<PermissionSetAssignment> assignments = [
      SELECT Id, AssigneeId, PermissionSetId, PermissionSet.Name
      FROM PermissionSetAssignment
      WHERE PermissionSet.PermissionsModifyAllData = true
      AND AssigneeId IN :targetUserIds
  ];

  // Step 2: Create replacement permission set
  PermissionSet ps = new PermissionSet(
      Name = '{{permission_set_name}}',
      Label = '{{permission_set_label}}'
  );
  insert ps;

  // Step 3: Reassign users
  List<PermissionSetAssignment> newAssignments = new List<PermissionSetAssignment>();
  for (PermissionSetAssignment oldAssignment : assignments) {
      newAssignments.add(new PermissionSetAssignment(
          AssigneeId = oldAssignment.AssigneeId,
          PermissionSetId = ps.Id
      ));
  }
  insert newAssignments;

  // Step 4: Remove old assignments
  delete assignments;
Placeholders__c: {"permission_set_name": "String", "permission_set_label": "String", "targetUserIds": "List<Id>"}
Rollback_Script__c: |
  // Restore original permission set assignments
  // (Store original assignments before deletion)
```

#### Phase 2: Code Generation Service (Week 2)

| Task | File | Description |
|------|------|-------------|
| 2.1 | `classes/FixCodeGeneratorService.cls` | Generate fix code from templates |
| 2.2 | `classes/FixCodeValidatorService.cls` | Validate generated code |
| 2.3 | `classes/FixCodeGeneratorServiceTest.cls` | Test coverage |

**FixCodeGeneratorService.cls Specification:**

```apex
public with sharing class FixCodeGeneratorService {

    @AuraEnabled
    public static FixSuggestion generateFix(String gapId);

    @AuraEnabled
    public static FixSuggestion generateFixWithContext(String gapId, Map<String, Object> context);

    @AuraEnabled
    public static ValidationResult validateFix(String fixId);

    @AuraEnabled
    public static ApplyResult applyFix(String fixId, Boolean dryRun);

    public class FixSuggestion {
        @AuraEnabled public String gapId;
        @AuraEnabled public String title;
        @AuraEnabled public String summary;
        @AuraEnabled public List<FixStep> steps;
        @AuraEnabled public String apexCode;
        @AuraEnabled public String metadataXml;
        @AuraEnabled public String estimatedTime;
        @AuraEnabled public Decimal riskReduction;
        @AuraEnabled public List<String> prerequisites;
        @AuraEnabled public String rollbackScript;
        @AuraEnabled public Boolean canAutoApply;
    }

    public class FixStep {
        @AuraEnabled public Integer stepNumber;
        @AuraEnabled public String title;
        @AuraEnabled public String description;
        @AuraEnabled public String codeSnippet;
        @AuraEnabled public String codeLanguage; // apex, xml, json
    }

    public class ValidationResult {
        @AuraEnabled public Boolean isValid;
        @AuraEnabled public List<String> warnings;
        @AuraEnabled public List<String> errors;
        @AuraEnabled public Map<String, Object> impactAnalysis;
    }

    public class ApplyResult {
        @AuraEnabled public Boolean success;
        @AuraEnabled public String message;
        @AuraEnabled public String rollbackId;
        @AuraEnabled public List<String> changesApplied;
    }
}
```

#### Phase 3: AI-Enhanced Suggestions (Week 3)

| Task | File | Description |
|------|------|-------------|
| 3.1 | Update `ElaroComplianceCopilotService.cls` | Add fix generation prompts |
| 3.2 | `classes/AIFixEnhancementService.cls` | Enhance templates with AI |
| 3.3 | Integration with explanation service | Link explanations to fixes |

**AI Enhancement Process:**

1. Start with template-based fix
2. Query org metadata for context (field names, object relationships)
3. Use Claude to customize fix for specific org configuration
4. Validate generated code syntax
5. Return enhanced suggestion with org-specific details

#### Phase 4: LWC Integration (Week 4)

| Task | File | Description |
|------|------|-------------|
| 4.1 | `lwc/fixSuggestionCard/*` | Display fix suggestions |
| 4.2 | `lwc/codeSnippetViewer/*` | Syntax-highlighted code display |
| 4.3 | `lwc/fixApplyModal/*` | Apply fix with confirmation |
| 4.4 | Update `complianceGapList` | Add "Get Fix" button |

### Custom Objects & Fields

**Elaro_Fix_Suggestion__c**

| Field | Type | Description |
|-------|------|-------------|
| `Gap__c` | Lookup(Compliance_Gap__c) | Related gap |
| `Template__c` | Lookup(Remediation_Template__mdt) | Source template |
| `Generated_Code__c` | Long Text(131072) | Generated Apex/XML |
| `Steps_JSON__c` | Long Text(32000) | Steps as JSON |
| `Status__c` | Picklist | `Draft`, `Validated`, `Applied`, `Rolled Back` |
| `Applied_At__c` | Datetime | When applied |
| `Applied_By__c` | Lookup(User) | Who applied |
| `Rollback_Data__c` | Long Text(131072) | Data for rollback |
| `Risk_Reduction__c` | Number | Points reduced |

### Testing Requirements

| Test Class | Coverage Target |
|------------|-----------------|
| `RemediationTemplateServiceTest` | 95% |
| `FixCodeGeneratorServiceTest` | 95% |
| `FixCodeValidatorServiceTest` | 95% |
| `fixSuggestionCard.test.js` | 90% |

### Dependencies

- `Compliance_Gap__c` object (existing)
- Claude API (existing)
- `RemediationOrchestrator.cls` (existing - enhance)

### Success Metrics

| Metric | Target |
|--------|--------|
| Fix application success rate | >95% |
| Time to generate fix | <10 seconds |
| User adoption | >60% of gaps get fixes |
| Rollback success rate | 100% |

---

## Feature 3: Jira Integration

### Problem Statement

Compliance teams work in Jira, but Elaro alerts live in Salesforce/Slack. This creates silos and missed follow-ups.

### Solution

Auto-create Jira tickets for high-risk changes with bidirectional sync.

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Jira Integration Flow                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Salesforce                              Jira                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Compliance   â”‚â”€â”€â”€Create Issueâ”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Jira Issue       â”‚        â”‚
â”‚  â”‚ Gap/Alert    â”‚                       â”‚                  â”‚        â”‚
â”‚  â”‚              â”‚â—€â”€â”€Status Updateâ”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                                       â”‚                    â”‚
â”‚         â”‚                                       â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Jira        â”‚â”€â”€â”€â”€â–¶â”‚ Named       â”‚â”€â”€â”€â”€â”‚ Jira REST   â”‚            â”‚
â”‚  â”‚ Integration â”‚     â”‚ Credential  â”‚    â”‚ API         â”‚            â”‚
â”‚  â”‚ Service     â”‚â—€â”€â”€â”€â”€â”‚             â”‚â—€â”€â”€â”€â”‚             â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                                       â”‚                    â”‚
â”‚         â”‚           Webhook                     â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚  â”‚ Jira        â”‚                                                     â”‚
â”‚  â”‚ Webhook     â”‚                                                     â”‚
â”‚  â”‚ Handler     â”‚                                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Tasks

#### Phase 1: Core Integration (Week 1)

| Task | File | Description |
|------|------|-------------|
| 1.1 | `namedCredentials/Jira_API.namedCredential-meta.xml` | Jira API credentials |
| 1.2 | `classes/JiraIntegrationService.cls` | Main integration service |
| 1.3 | `classes/JiraIntegrationServiceTest.cls` | Test coverage |
| 1.4 | `objects/Elaro_Jira_Settings__c.object-meta.xml` | Custom settings |

**JiraIntegrationService.cls Specification:**

```apex
public with sharing class JiraIntegrationService {

    private static final String NAMED_CREDENTIAL = 'callout:Jira_API';

    // Issue Creation
    @AuraEnabled
    public static JiraIssue createIssue(String gapId, String priority);

    @future(callout=true)
    public static void createIssueAsync(String gapId, String priority);

    // Issue Sync
    @AuraEnabled
    public static JiraIssue getIssueStatus(String jiraKey);

    @AuraEnabled
    public static void syncIssueStatus(String gapId);

    // Bulk Operations
    @AuraEnabled
    public static List<JiraIssue> createBulkIssues(List<String> gapIds);

    // Comments
    @AuraEnabled
    public static void addComment(String jiraKey, String comment);

    // Attachments
    @AuraEnabled
    public static void attachEvidence(String jiraKey, String evidenceId);

    public class JiraIssue {
        @AuraEnabled public String key;
        @AuraEnabled public String summary;
        @AuraEnabled public String description;
        @AuraEnabled public String status;
        @AuraEnabled public String priority;
        @AuraEnabled public String assignee;
        @AuraEnabled public String url;
        @AuraEnabled public Datetime createdAt;
        @AuraEnabled public Datetime updatedAt;
    }

    public class JiraSettings {
        public String projectKey;
        public String issueType;
        public String defaultPriority;
        public Boolean autoCreate;
        public Decimal riskThreshold;
    }
}
```

**API Endpoints Used:**

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/rest/api/3/issue` | POST | Create issue |
| `/rest/api/3/issue/{issueIdOrKey}` | GET | Get issue details |
| `/rest/api/3/issue/{issueIdOrKey}` | PUT | Update issue |
| `/rest/api/3/issue/{issueIdOrKey}/comment` | POST | Add comment |
| `/rest/api/3/issue/{issueIdOrKey}/attachments` | POST | Add attachment |

#### Phase 2: Webhook Handler (Week 2)

| Task | File | Description |
|------|------|-------------|
| 2.1 | `classes/JiraWebhookHandler.cls` | Process Jira webhooks |
| 2.2 | `sites/*` | Configure Site for webhook endpoint |
| 2.3 | `classes/JiraWebhookHandlerTest.cls` | Test coverage |

**JiraWebhookHandler.cls:**

```apex
@RestResource(urlMapping='/jira/webhook/*')
global with sharing class JiraWebhookHandler {

    @HttpPost
    global static void handleWebhook() {
        RestRequest req = RestContext.request;
        RestResponse res = RestContext.response;

        try {
            String body = req.requestBody.toString();
            Map<String, Object> payload = (Map<String, Object>)JSON.deserializeUntyped(body);

            String webhookEvent = (String)payload.get('webhookEvent');

            switch on webhookEvent {
                when 'jira:issue_updated' {
                    handleIssueUpdated(payload);
                }
                when 'jira:issue_deleted' {
                    handleIssueDeleted(payload);
                }
                when 'comment_created' {
                    handleCommentCreated(payload);
                }
            }

            res.statusCode = 200;
            res.responseBody = Blob.valueOf('{"status": "success"}');

        } catch (Exception e) {
            res.statusCode = 500;
            res.responseBody = Blob.valueOf('{"error": "' + e.getMessage() + '"}');
        }
    }

    private static void handleIssueUpdated(Map<String, Object> payload) {
        // Update Compliance_Gap__c status based on Jira status
    }
}
```

### Custom Objects & Fields

**Elaro_Jira_Settings__c (Custom Settings)**

| Field | Type | Default |
|-------|------|---------|
| `Jira_Instance_URL__c` | URL | |
| `Project_Key__c` | Text(10) | `COMPLIANCE` |
| `Issue_Type__c` | Text(50) | `Task` |
| `Default_Priority__c` | Picklist | `High` |
| `Auto_Create_Enabled__c` | Checkbox | false |
| `Risk_Threshold__c` | Number | 8.0 |
| `Webhook_Secret__c` | Text(255) | |

**Compliance_Gap__c (Add Fields)**

| Field | Type | Description |
|-------|------|-------------|
| `Jira_Issue_Key__c` | Text(50) | Jira issue key |
| `Jira_Issue_URL__c` | URL | Link to Jira issue |
| `Jira_Status__c` | Text(50) | Current Jira status |
| `Jira_Last_Sync__c` | Datetime | Last sync timestamp |

### LWC Updates

| Task | File | Description |
|------|------|-------------|
| 2.1 | `lwc/jiraIssueCard/*` | Display linked Jira issue |
| 2.2 | `lwc/jiraCreateModal/*` | Create Jira issue modal |
| 2.3 | Update `complianceGapList` | Add Jira actions |

### Testing Requirements

| Test Class | Coverage Target |
|------------|-----------------|
| `JiraIntegrationServiceTest` | 95% |
| `JiraWebhookHandlerTest` | 95% |
| `jiraIssueCard.test.js` | 90% |

### Dependencies

- Jira Cloud instance with API access
- Jira API token
- Salesforce Site for webhook

### Success Metrics

| Metric | Target |
|--------|--------|
| Jira adoption | >50% of customers enable |
| Sync latency | <30 seconds |
| Issue creation success | >99% |

---

## Feature 4: Compliance Report Scheduler

### Problem Statement

Compliance teams want automated recurring reports, not on-demand scans.

### Solution

Scheduled jobs that email compliance reports to stakeholders with configurable frequencies.

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Report Scheduler Flow                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Scheduled    â”‚â”€â”€â”€â”€â–¶â”‚ ComplianceReportâ”‚â”€â”€â”€â”€â–¶â”‚ PDF Generator    â”‚ â”‚
â”‚  â”‚ Job (Cron)   â”‚     â”‚ Scheduler       â”‚     â”‚ (Visualforce)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚                       â”‚           â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚           â”‚
â”‚                   â”‚ Report Templates        â”‚          â”‚           â”‚
â”‚                   â”‚ (Custom Metadata)       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                â”‚                                    â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                   â”‚ Email Service           â”‚                      â”‚
â”‚                   â”‚ (Messaging API)         â”‚                      â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Tasks

#### Week 1: Full Implementation

| Task | File | Description |
|------|------|-------------|
| 1.1 | `classes/ComplianceReportScheduler.cls` | Main scheduler class |
| 1.2 | `classes/ComplianceReportGenerator.cls` | Generate report content |
| 1.3 | `classes/ComplianceReportSchedulerTest.cls` | Test coverage |
| 1.4 | `pages/ComplianceReport.page` | Visualforce PDF template |
| 1.5 | `customMetadata/Report_Schedule__mdt.*` | Schedule configuration |
| 1.6 | `lwc/reportSchedulerConfig/*` | Configuration UI |

**ComplianceReportScheduler.cls:**

```apex
public with sharing class ComplianceReportScheduler implements Schedulable {

    public enum Frequency { DAILY, WEEKLY, MONTHLY }

    private Frequency frequency;
    private List<String> recipients;
    private String framework;

    public ComplianceReportScheduler(Frequency freq, List<String> recipients, String framework) {
        this.frequency = freq;
        this.recipients = recipients;
        this.framework = framework;
    }

    public void execute(SchedulableContext ctx) {
        generateAndSendReport();
    }

    @AuraEnabled
    public static String scheduleReport(String frequency, List<String> recipients, String framework) {
        String cronExpression = getCronExpression(Frequency.valueOf(frequency));
        String jobName = 'Elaro ' + frequency + ' Report - ' + framework;

        ComplianceReportScheduler scheduler = new ComplianceReportScheduler(
            Frequency.valueOf(frequency),
            recipients,
            framework
        );

        return System.schedule(jobName, cronExpression, scheduler);
    }

    @AuraEnabled
    public static List<ScheduledReport> getScheduledReports() {
        List<CronTrigger> jobs = [
            SELECT Id, CronJobDetail.Name, NextFireTime, State
            FROM CronTrigger
            WHERE CronJobDetail.Name LIKE 'Elaro%Report%'
        ];
        // Convert to ScheduledReport wrapper
    }

    @AuraEnabled
    public static void cancelScheduledReport(String jobId) {
        System.abortJob(jobId);
    }

    private void generateAndSendReport() {
        // 1. Calculate compliance score
        ElaroComplianceScorer.ScoreResult score =
            ElaroComplianceScorer.calculateReadinessScore();

        // 2. Get compliance gaps
        List<Compliance_Gap__c> gaps = [
            SELECT Id, Name, Severity__c, Status__c, Framework__c
            FROM Compliance_Gap__c
            WHERE Framework__c = :framework AND Status__c != 'Resolved'
            ORDER BY Severity__c DESC
            LIMIT 50
        ];

        // 3. Generate PDF
        PageReference pdfPage = Page.ComplianceReport;
        pdfPage.getParameters().put('framework', framework);
        Blob pdfContent = pdfPage.getContentAsPDF();

        // 4. Send email
        sendReportEmail(pdfContent, score);
    }

    private void sendReportEmail(Blob pdfContent, ElaroComplianceScorer.ScoreResult score) {
        Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
        email.setToAddresses(recipients);
        email.setSubject('Elaro Compliance Report - ' + framework + ' - ' + Date.today().format());
        email.setHtmlBody(buildEmailBody(score));

        Messaging.EmailFileAttachment attachment = new Messaging.EmailFileAttachment();
        attachment.setFileName('Compliance_Report_' + Date.today().format() + '.pdf');
        attachment.setBody(pdfContent);
        attachment.setContentType('application/pdf');
        email.setFileAttachments(new List<Messaging.EmailFileAttachment>{ attachment });

        if (!Test.isRunningTest()) {
            Messaging.sendEmail(new List<Messaging.SingleEmailMessage>{ email });
        }
    }

    private static String getCronExpression(Frequency freq) {
        switch on freq {
            when DAILY { return '0 0 8 * * ?'; } // 8 AM daily
            when WEEKLY { return '0 0 8 ? * MON'; } // 8 AM Monday
            when MONTHLY { return '0 0 8 1 * ?'; } // 8 AM 1st of month
            when else { return '0 0 8 ? * MON'; }
        }
    }

    public class ScheduledReport {
        @AuraEnabled public String jobId;
        @AuraEnabled public String name;
        @AuraEnabled public String frequency;
        @AuraEnabled public String framework;
        @AuraEnabled public Datetime nextRun;
        @AuraEnabled public String status;
    }
}
```

**ComplianceReport.page (Visualforce):**

```xml
<apex:page controller="ComplianceReportController"
           renderAs="pdf"
           applyHtmlTag="false"
           standardStylesheets="false">
    <head>
        <style type="text/css">
            body { font-family: Arial, sans-serif; }
            .header { text-align: center; margin-bottom: 20px; }
            .score-box { background: #f0f0f0; padding: 20px; border-radius: 8px; }
            .gap-table { width: 100%; border-collapse: collapse; }
            .gap-table th, .gap-table td { border: 1px solid #ddd; padding: 8px; }
            .critical { color: #c23934; }
            .high { color: #e87722; }
            .medium { color: #f7b924; }
            .low { color: #4bca81; }
        </style>
    </head>

    <div class="header">
        <h1>Elaro Compliance Report</h1>
        <p>Framework: {!framework} | Generated: {!TODAY()}</p>
    </div>

    <div class="score-box">
        <h2>Overall Compliance Score: {!score}/100</h2>
        <p>Rating: {!rating}</p>
    </div>

    <h3>Open Compliance Gaps</h3>
    <table class="gap-table">
        <tr>
            <th>Gap</th>
            <th>Severity</th>
            <th>Status</th>
            <th>Framework</th>
        </tr>
        <apex:repeat value="{!gaps}" var="gap">
            <tr>
                <td>{!gap.Name}</td>
                <td class="{!LOWER(gap.Severity__c)}">{!gap.Severity__c}</td>
                <td>{!gap.Status__c}</td>
                <td>{!gap.Framework__c}</td>
            </tr>
        </apex:repeat>
    </table>

    <h3>Trend Analysis</h3>
    <p>Score change from last period: {!scoreChange}</p>

    <div class="footer">
        <p>Generated by Elaro Compliance Platform</p>
    </div>
</apex:page>
```

### Custom Metadata

**Report_Schedule__mdt**

| Field | Type |
|-------|------|
| `Frequency__c` | Picklist (Daily/Weekly/Monthly) |
| `Framework__c` | Text |
| `Recipients__c` | Long Text (comma-separated emails) |
| `Include_Gaps__c` | Checkbox |
| `Include_Trends__c` | Checkbox |
| `Active__c` | Checkbox |

### LWC Components

**reportSchedulerConfig**

```javascript
// reportSchedulerConfig.js
import { LightningElement, track, wire } from 'lwc';
import scheduleReport from '@salesforce/apex/ComplianceReportScheduler.scheduleReport';
import getScheduledReports from '@salesforce/apex/ComplianceReportScheduler.getScheduledReports';
import cancelScheduledReport from '@salesforce/apex/ComplianceReportScheduler.cancelScheduledReport';

export default class ReportSchedulerConfig extends LightningElement {
    @track scheduledReports = [];
    @track frequency = 'WEEKLY';
    @track recipients = '';
    @track framework = 'ALL';

    frequencyOptions = [
        { label: 'Daily', value: 'DAILY' },
        { label: 'Weekly', value: 'WEEKLY' },
        { label: 'Monthly', value: 'MONTHLY' }
    ];

    frameworkOptions = [
        { label: 'All Frameworks', value: 'ALL' },
        { label: 'HIPAA', value: 'HIPAA' },
        { label: 'SOC 2', value: 'SOC2' },
        { label: 'NIST', value: 'NIST' }
        // ... more frameworks
    ];

    @wire(getScheduledReports)
    wiredReports({ error, data }) {
        if (data) {
            this.scheduledReports = data;
        }
    }

    handleSchedule() {
        const recipientList = this.recipients.split(',').map(e => e.trim());
        scheduleReport({
            frequency: this.frequency,
            recipients: recipientList,
            framework: this.framework
        })
        .then(result => {
            // Show success toast
        })
        .catch(error => {
            // Show error toast
        });
    }

    handleCancel(event) {
        const jobId = event.target.dataset.jobId;
        cancelScheduledReport({ jobId })
        .then(() => {
            // Refresh list
        });
    }
}
```

### Testing Requirements

| Test Class | Coverage Target |
|------------|-----------------|
| `ComplianceReportSchedulerTest` | 95% |
| `ComplianceReportGeneratorTest` | 95% |
| `reportSchedulerConfig.test.js` | 90% |

### Dependencies

- `ElaroComplianceScorer.cls` (existing)
- `Compliance_Gap__c` (existing)
- Visualforce enabled

### Success Metrics

| Metric | Target |
|--------|--------|
| Report delivery success | >99% |
| Email open rate | >50% |
| Configuration adoption | >30% of customers |

---

## Feature 5: Mobile Alerts

### Problem Statement

Critical drift events happen outside business hours. On-call teams need mobile notifications.

### Solution

Push notifications to Salesforce Mobile App for critical events with escalation.

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mobile Alert Flow                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Platform     â”‚â”€â”€â”€â”€â–¶â”‚ MobileAlert     â”‚â”€â”€â”€â”€â–¶â”‚ Custom           â”‚ â”‚
â”‚  â”‚ Event        â”‚     â”‚ Publisher       â”‚     â”‚ Notification     â”‚ â”‚
â”‚  â”‚ (trigger)    â”‚     â”‚                 â”‚     â”‚ API              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚                       â”‚           â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚           â”‚
â”‚                   â”‚ On-Call Schedule        â”‚          â”‚           â”‚
â”‚                   â”‚ (Custom Object)         â”‚          â–¼           â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                                â”‚               â”‚ Salesforce       â”‚â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ Mobile App       â”‚â”‚
â”‚                   â”‚ Escalation Manager      â”‚  â”‚ (Push            â”‚â”‚
â”‚                   â”‚ (if not acknowledged)   â”‚  â”‚  Notification)   â”‚â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Tasks

#### Phase 1: Core Mobile Alerts (Week 1)

| Task | File | Description |
|------|------|-------------|
| 1.1 | `classes/MobileAlertPublisher.cls` | Publish mobile notifications |
| 1.2 | `classes/MobileAlertPublisherTest.cls` | Test coverage |
| 1.3 | `notificationTypes/Elaro_Critical_Alert.notiftype-meta.xml` | Custom notification type |
| 1.4 | `objects/Elaro_On_Call_Schedule__c.object-meta.xml` | On-call rotation |

**MobileAlertPublisher.cls:**

```apex
public with sharing class MobileAlertPublisher {

    private static final String CRITICAL_NOTIFICATION_TYPE = 'Elaro_Critical_Alert';
    private static final String HIGH_NOTIFICATION_TYPE = 'Elaro_High_Alert';

    @AuraEnabled
    public static void publishCriticalAlert(String alertId, String title, String message) {
        // Get on-call users
        List<Id> recipients = getOnCallUsers();

        if (recipients.isEmpty()) {
            // Fallback to admins
            recipients = getAdminUsers();
        }

        publishNotification(CRITICAL_NOTIFICATION_TYPE, alertId, title, message, recipients);

        // Schedule escalation check
        scheduleEscalationCheck(alertId, 30); // 30 minutes
    }

    @AuraEnabled
    public static void publishHighAlert(String alertId, String title, String message) {
        List<Id> recipients = getOnCallUsers();
        publishNotification(HIGH_NOTIFICATION_TYPE, alertId, title, message, recipients);
    }

    @AuraEnabled
    public static void acknowledgeAlert(String alertId) {
        // Mark alert as acknowledged
        Alert__c alert = [SELECT Id, Acknowledged__c, Acknowledged_By__c, Acknowledged_At__c
                         FROM Alert__c WHERE Id = :alertId LIMIT 1];
        alert.Acknowledged__c = true;
        alert.Acknowledged_By__c = UserInfo.getUserId();
        alert.Acknowledged_At__c = Datetime.now();
        update alert;

        // Cancel escalation
        cancelEscalation(alertId);
    }

    @AuraEnabled
    public static void snoozeAlert(String alertId, Integer minutes) {
        // Snooze for specified duration
        Datetime snoozeUntil = Datetime.now().addMinutes(minutes);

        Alert__c alert = [SELECT Id FROM Alert__c WHERE Id = :alertId LIMIT 1];
        alert.Snoozed_Until__c = snoozeUntil;
        update alert;

        // Reschedule notification
        scheduleDelayedNotification(alertId, minutes);
    }

    private static void publishNotification(String typeName, String targetId, String title, String body, List<Id> recipients) {
        CustomNotificationType notifType = [
            SELECT Id FROM CustomNotificationType
            WHERE DeveloperName = :typeName LIMIT 1
        ];

        Messaging.CustomNotification notification = new Messaging.CustomNotification();
        notification.setNotificationTypeId(notifType.Id);
        notification.setTargetId(targetId);
        notification.setTitle(title);
        notification.setBody(body);

        Set<String> recipientSet = new Set<String>();
        for (Id recipientId : recipients) {
            recipientSet.add(String.valueOf(recipientId));
        }

        try {
            notification.send(recipientSet);
        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Mobile notification failed: ' + e.getMessage());
        }
    }

    private static List<Id> getOnCallUsers() {
        Datetime now = Datetime.now();
        List<Elaro_On_Call_Schedule__c> schedules = [
            SELECT User__c FROM Elaro_On_Call_Schedule__c
            WHERE Start_Time__c <= :now AND End_Time__c >= :now
            AND Active__c = true
        ];

        List<Id> userIds = new List<Id>();
        for (Elaro_On_Call_Schedule__c schedule : schedules) {
            userIds.add(schedule.User__c);
        }
        return userIds;
    }

    private static List<Id> getAdminUsers() {
        List<PermissionSetAssignment> admins = [
            SELECT AssigneeId FROM PermissionSetAssignment
            WHERE PermissionSet.Name = 'Elaro_Admin'
            LIMIT 10
        ];

        List<Id> userIds = new List<Id>();
        for (PermissionSetAssignment psa : admins) {
            userIds.add(psa.AssigneeId);
        }
        return userIds;
    }

    private static void scheduleEscalationCheck(String alertId, Integer minutes) {
        String jobName = 'Elaro Escalation - ' + alertId;
        String cronExp = getCronForMinutesFromNow(minutes);

        System.schedule(jobName, cronExp, new MobileAlertEscalator(alertId));
    }

    private static void cancelEscalation(String alertId) {
        String jobName = 'Elaro Escalation - ' + alertId;
        List<CronTrigger> jobs = [
            SELECT Id FROM CronTrigger WHERE CronJobDetail.Name = :jobName
        ];
        for (CronTrigger job : jobs) {
            System.abortJob(job.Id);
        }
    }

    private static String getCronForMinutesFromNow(Integer minutes) {
        Datetime futureTime = Datetime.now().addMinutes(minutes);
        return futureTime.second() + ' ' + futureTime.minute() + ' ' +
               futureTime.hour() + ' ' + futureTime.day() + ' ' +
               futureTime.month() + ' ? ' + futureTime.year();
    }
}
```

#### Phase 2: Escalation & On-Call (Week 2)

| Task | File | Description |
|------|------|-------------|
| 2.1 | `classes/MobileAlertEscalator.cls` | Escalation logic |
| 2.2 | `classes/OnCallScheduleService.cls` | Manage on-call rotations |
| 2.3 | `lwc/onCallScheduleManager/*` | UI for managing on-call |
| 2.4 | Update `ElaroComplianceAlert` | Integrate mobile alerts |

**MobileAlertEscalator.cls:**

```apex
public with sharing class MobileAlertEscalator implements Schedulable {

    private String alertId;

    public MobileAlertEscalator(String alertId) {
        this.alertId = alertId;
    }

    public void execute(SchedulableContext ctx) {
        // Check if alert was acknowledged
        Alert__c alert = [
            SELECT Id, Acknowledged__c, Title__c, Description__c, Escalation_Level__c
            FROM Alert__c WHERE Id = :alertId LIMIT 1
        ];

        if (alert.Acknowledged__c) {
            return; // Already acknowledged
        }

        // Escalate
        Integer currentLevel = alert.Escalation_Level__c != null ?
                              Integer.valueOf(alert.Escalation_Level__c) : 0;

        List<Id> escalationRecipients = getEscalationRecipients(currentLevel + 1);

        if (!escalationRecipients.isEmpty()) {
            // Send escalated notification
            MobileAlertPublisher.publishCriticalAlert(
                alertId,
                'ğŸš¨ ESCALATED: ' + alert.Title__c,
                'Alert not acknowledged. Level ' + (currentLevel + 1) + ' escalation.'
            );

            // Update escalation level
            alert.Escalation_Level__c = currentLevel + 1;
            update alert;

            // Schedule next escalation if not max level
            if (currentLevel + 1 < 3) {
                scheduleNextEscalation(alertId, 15); // 15 minutes
            }
        }
    }

    private List<Id> getEscalationRecipients(Integer level) {
        // Level 1: Team lead
        // Level 2: Manager
        // Level 3: CISO/Director
        List<Elaro_Escalation_Path__c> paths = [
            SELECT User__c FROM Elaro_Escalation_Path__c
            WHERE Level__c = :level AND Active__c = true
        ];

        List<Id> userIds = new List<Id>();
        for (Elaro_Escalation_Path__c path : paths) {
            userIds.add(path.User__c);
        }
        return userIds;
    }

    private void scheduleNextEscalation(String alertId, Integer minutes) {
        Datetime futureTime = Datetime.now().addMinutes(minutes);
        String cronExp = futureTime.second() + ' ' + futureTime.minute() + ' ' +
                        futureTime.hour() + ' ' + futureTime.day() + ' ' +
                        futureTime.month() + ' ? ' + futureTime.year();

        System.schedule('Elaro Escalation - ' + alertId, cronExp,
                       new MobileAlertEscalator(alertId));
    }
}
```

### Custom Objects

**Elaro_On_Call_Schedule__c**

| Field | Type | Description |
|-------|------|-------------|
| `User__c` | Lookup(User) | On-call user |
| `Start_Time__c` | Datetime | Shift start |
| `End_Time__c` | Datetime | Shift end |
| `Active__c` | Checkbox | Is active |
| `Rotation_Name__c` | Text | Rotation identifier |

**Elaro_Escalation_Path__c**

| Field | Type | Description |
|-------|------|-------------|
| `User__c` | Lookup(User) | Escalation recipient |
| `Level__c` | Number | Escalation level (1-3) |
| `Active__c` | Checkbox | Is active |
| `Notification_Method__c` | Picklist | Mobile, Email, Both |

**Alert__c (Add Fields)**

| Field | Type | Description |
|-------|------|-------------|
| `Acknowledged__c` | Checkbox | Was acknowledged |
| `Acknowledged_By__c` | Lookup(User) | Who acknowledged |
| `Acknowledged_At__c` | Datetime | When acknowledged |
| `Escalation_Level__c` | Number | Current escalation level |
| `Snoozed_Until__c` | Datetime | Snooze expiry |

### Custom Notification Types

**Elaro_Critical_Alert.notiftype-meta.xml:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<CustomNotificationType xmlns="http://soap.sforce.com/2006/04/metadata">
    <customNotifTypeName>Elaro_Critical_Alert</customNotifTypeName>
    <description>Critical compliance alerts requiring immediate attention</description>
    <desktop>true</desktop>
    <masterLabel>Elaro Critical Alert</masterLabel>
    <mobile>true</mobile>
    <slack>false</slack>
</CustomNotificationType>
```

### LWC Components

| Component | Purpose |
|-----------|---------|
| `onCallScheduleManager` | Manage on-call rotations |
| `escalationPathConfig` | Configure escalation paths |
| `alertAcknowledgeButton` | Quick acknowledge action |

### Testing Requirements

| Test Class | Coverage Target |
|------------|-----------------|
| `MobileAlertPublisherTest` | 95% |
| `MobileAlertEscalatorTest` | 95% |
| `OnCallScheduleServiceTest` | 95% |

### Dependencies

- Custom Notification Types
- Salesforce Mobile App
- `Alert__c` object (existing)

### Success Metrics

| Metric | Target |
|--------|--------|
| Alert response time | <15 minutes |
| Acknowledgment rate | >95% |
| Escalation triggered | <10% of alerts |

---

## Implementation Timeline

```
Week 1-3: AI Change Explanations
â”œâ”€â”€ Week 1: Core Explanation Service
â”œâ”€â”€ Week 2: Framework-Specific Prompts
â””â”€â”€ Week 3: LWC Integration

Week 4-7: Suggested Fixes
â”œâ”€â”€ Week 4: Fix Template Library
â”œâ”€â”€ Week 5: Code Generation Service
â”œâ”€â”€ Week 6: AI Enhancement
â””â”€â”€ Week 7: LWC Integration

Week 8-9: Jira Integration
â”œâ”€â”€ Week 8: Core Integration & API
â””â”€â”€ Week 9: Webhook Handler & UI

Week 10: Compliance Report Scheduler
â””â”€â”€ Full implementation

Week 11-12: Mobile Alerts
â”œâ”€â”€ Week 11: Core Mobile Alerts
â””â”€â”€ Week 12: Escalation & On-Call
```

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Claude API rate limits | Implement caching (1-hour TTL), batch requests |
| Jira API authentication | Use OAuth 2.0 with refresh tokens |
| Mobile notification delivery | Fallback to email, track delivery status |
| Template maintenance | Version templates, allow rollback |
| Cost overruns (AI) | Token budgets per org, cost tracking dashboard |

---

## Dependencies Summary

### New Named Credentials

| Name | Purpose |
|------|---------|
| `Jira_API` | Jira Cloud REST API |

### Existing Dependencies

| Component | Used By |
|-----------|---------|
| `Elaro_Claude_API` | AI Explanations, Suggested Fixes |
| `Slack_Webhook` | All features (notifications) |
| `Teams_Webhook` | All features (notifications) |
| `local.ElaroCache` | AI caching |

### New Custom Objects

| Object | Feature |
|--------|---------|
| `Elaro_AI_Explanation__c` | AI Explanations |
| `Elaro_Fix_Suggestion__c` | Suggested Fixes |
| `Elaro_On_Call_Schedule__c` | Mobile Alerts |
| `Elaro_Escalation_Path__c` | Mobile Alerts |

### New Custom Metadata

| Metadata | Feature |
|----------|---------|
| `AI_Explanation_Template__mdt` | AI Explanations |
| `Remediation_Template__mdt` | Suggested Fixes |
| `Report_Schedule__mdt` | Report Scheduler |

---

## Success Criteria

### v1.5 Release Readiness

- [ ] All 5 features implemented and tested
- [ ] 95%+ Apex code coverage
- [ ] 90%+ LWC test coverage
- [ ] Security review passed
- [ ] Performance benchmarks met
- [ ] Documentation complete
- [ ] User acceptance testing passed

### Post-Release Metrics (30 days)

| Metric | Target |
|--------|--------|
| Time-to-Remediation | <1 hour (from 4+ hours) |
| AI Explanation Accuracy | >90% user satisfaction |
| Jira Adoption | >50% of customers |
| Report Scheduler Usage | >30% of customers |
| Alert Response Time | <15 minutes |

---

## Appendix A: File Manifest

### New Apex Classes

```
force-app/main/default/classes/
â”œâ”€â”€ AIExplanationService.cls
â”œâ”€â”€ AIExplanationServiceTest.cls
â”œâ”€â”€ AIExplanationPromptBuilder.cls
â”œâ”€â”€ AIExplanationPromptBuilderTest.cls
â”œâ”€â”€ FixCodeGeneratorService.cls
â”œâ”€â”€ FixCodeGeneratorServiceTest.cls
â”œâ”€â”€ FixCodeValidatorService.cls
â”œâ”€â”€ FixCodeValidatorServiceTest.cls
â”œâ”€â”€ RemediationTemplateService.cls
â”œâ”€â”€ RemediationTemplateServiceTest.cls
â”œâ”€â”€ AIFixEnhancementService.cls
â”œâ”€â”€ AIFixEnhancementServiceTest.cls
â”œâ”€â”€ JiraIntegrationService.cls
â”œâ”€â”€ JiraIntegrationServiceTest.cls
â”œâ”€â”€ JiraWebhookHandler.cls
â”œâ”€â”€ JiraWebhookHandlerTest.cls
â”œâ”€â”€ ComplianceReportScheduler.cls
â”œâ”€â”€ ComplianceReportSchedulerTest.cls
â”œâ”€â”€ ComplianceReportGenerator.cls
â”œâ”€â”€ ComplianceReportGeneratorTest.cls
â”œâ”€â”€ ComplianceReportController.cls
â”œâ”€â”€ ComplianceReportControllerTest.cls
â”œâ”€â”€ MobileAlertPublisher.cls
â”œâ”€â”€ MobileAlertPublisherTest.cls
â”œâ”€â”€ MobileAlertEscalator.cls
â”œâ”€â”€ MobileAlertEscalatorTest.cls
â””â”€â”€ OnCallScheduleService.cls
â””â”€â”€ OnCallScheduleServiceTest.cls
```

### New LWC Components

```
force-app/main/default/lwc/
â”œâ”€â”€ aiExplanationCard/
â”œâ”€â”€ fixSuggestionCard/
â”œâ”€â”€ codeSnippetViewer/
â”œâ”€â”€ fixApplyModal/
â”œâ”€â”€ jiraIssueCard/
â”œâ”€â”€ jiraCreateModal/
â”œâ”€â”€ reportSchedulerConfig/
â”œâ”€â”€ onCallScheduleManager/
â”œâ”€â”€ escalationPathConfig/
â””â”€â”€ alertAcknowledgeButton/
```

### New Custom Objects

```
force-app/main/default/objects/
â”œâ”€â”€ Elaro_AI_Explanation__c/
â”œâ”€â”€ Elaro_Fix_Suggestion__c/
â”œâ”€â”€ Elaro_Jira_Settings__c/
â”œâ”€â”€ Elaro_On_Call_Schedule__c/
â””â”€â”€ Elaro_Escalation_Path__c/
```

### New Custom Metadata

```
force-app/main/default/customMetadata/
â”œâ”€â”€ AI_Explanation_Template__mdt/
â”œâ”€â”€ Remediation_Template__mdt/
â””â”€â”€ Report_Schedule__mdt/
```

---

## Appendix B: API Reference

### Claude API Prompts

See `AIExplanationPromptBuilder.cls` for framework-specific prompt templates.

### Jira API Endpoints

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/rest/api/3/issue` | Create issue |
| GET | `/rest/api/3/issue/{key}` | Get issue |
| PUT | `/rest/api/3/issue/{key}` | Update issue |
| POST | `/rest/api/3/issue/{key}/comment` | Add comment |
| POST | `/rest/api/3/issue/{key}/attachments` | Add attachment |
| GET | `/rest/api/3/project` | List projects |

### Webhook Payloads

See `JiraWebhookHandler.cls` for payload parsing.

---

*Document Version: 1.0*
*Last Updated: 2026-01-09*
*Author: Elaro Development Team*
