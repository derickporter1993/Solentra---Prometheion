name: Salesforce AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "force-app/**"
      - "force-app-healthcheck/**"

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

env:
  NODE_VERSION: "20.17.0"

jobs:
  code-analysis:
    name: Code Analyzer (AppExchange Rules)
    runs-on: ubuntu-latest
    outputs:
      sev1-violations: ${{ steps.sfca.outputs.num-sev1-violations }}
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v5
        with:
          node-version: ">= 20.9.0"

      - uses: actions/setup-java@v5
        with:
          java-version: ">= 11"
          distribution: "zulu"

      - uses: actions/setup-python@v6
        with:
          python-version: ">= 3.10"

      - name: Install Salesforce CLI and Code Analyzer
        run: |
          npm install -g @salesforce/cli@latest
          sf plugins install code-analyzer@latest

      - name: Run Code Analyzer (AppExchange Rules)
        id: sfca
        uses: forcedotcom/run-code-analyzer@v2
        with:
          run-arguments: --workspace . --rule-selector AppExchange
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fail on Critical Violations
        if: steps.sfca.outputs.num-sev1-violations > 0
        run: |
          echo "::error::Found ${{ steps.sfca.outputs.num-sev1-violations }} severity-1 violations. AppExchange submission will be rejected."
          exit 1

  ai-review:
    name: AI Code Review (Claude)
    runs-on: ubuntu-latest
    needs: code-analysis
    if: always()
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are a senior Salesforce platform architect conducting a code review
            against Winter '26 (API v65.0) and Spring '26 (API v66.0) standards.
            Focus on AppExchange security review readiness.

            Review ALL changed Apex (.cls), LWC (.js, .html), and metadata (.xml)
            files in this PR. For each file, evaluate against these criteria:

            ## AUTO-FAIL GATES (any one = automatic F)
            1. CRUD/FLS violation: SOQL or DML without USER_MODE enforcement
            2. SOQL or DML inside a loop
            3. Hardcoded credentials, API keys, or encryption keys
            4. Test coverage below 75% on any class
            5. Missing sharing declaration on any Apex class
            6. SOQL injection: string concatenation with user input in query
            7. XSS vulnerability: unescaped user input rendered in UI
            8. API version below v58.0

            ## WEIGHTED SCORECARD
            Score each category 1-5, then compute weighted total:
            - Security (25%): WITH USER_MODE for SOQL/DML, sharing model, no secrets
            - Governor Limits (20%): No SOQL/DML in loops, bulkification, Queueable
            - Test Quality (15%): Assert class, meaningful messages, 85%+ coverage
            - Maintainability (15%): Naming, complexity <= 15, null safety operators
            - Architecture (10%): Separation of concerns, error handling, caching
            - Documentation (5%): ApexDoc with @author/@since/@group, no @description
            - API Compliance (5%): v66.0, breaking change compliance (v61/v63/v65)
            - AppExchange (5%): Code Analyzer rules, lwc:if, SLDS, Custom Labels

            Weighted total = sum(score * weight * 20). Grade: A(90+) B(80+) C(70+) D(60+) F(<60)

            ## KEY STANDARDS
            - SOQL: WITH USER_MODE (NOT WITH SECURITY_ENFORCED)
            - DML: as user / AccessLevel.USER_MODE
            - Dynamic SOQL: Database.queryWithBinds() with AccessLevel.USER_MODE
            - Assertions: Assert class (NOT System.assertEquals)
            - Async: Queueable (NOT @future)
            - v65.0+: Abstract/override methods MUST have explicit access modifiers
            - v63.0: No JSON.serialize() on Exception objects
            - v61.0+: No Set modification during iteration
            - LWC: lwc:if (NOT if:true), Custom Labels for all strings

            ## OUTPUT FORMAT
            For each reviewed file produce:
            1. **Summary**: path, sharing, API version, purpose
            2. **Auto-Fail Gates**: PASS/FAIL for each gate
            3. **Findings**: table with severity, line, finding, fix
            4. **Scorecard**: filled weighted table
            5. **Grade**: letter grade with score

            End with:
            - **Overall PR Grade** (weighted average across files)
            - **Top 3 Critical Fixes** (highest impact)
            - **AppExchange Readiness**: Ready / Needs Work / Not Ready

  deploy-validation:
    name: Deployment Validation
    runs-on: ubuntu-latest
    needs: [code-analysis, ai-review]
    if: |
      always() &&
      needs.code-analysis.result == 'success' &&
      github.event.pull_request.base.ref == 'main'
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest

      - name: Authenticate to Validation Org
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sf org login sfdx-url --sfdx-url-file auth.txt --alias validation-org
          rm auth.txt

      - name: Validate Deployment (Dry Run)
        run: |
          sf project deploy start \
            --target-org validation-org \
            --dry-run \
            --test-level RunLocalTests \
            --wait 30
