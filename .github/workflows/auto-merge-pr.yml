name: Auto-merge Pull Requests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status: {}

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run for PRs from Copilot or approved PRs
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'pull_request_review' ||
      github.event_name == 'check_suite' ||
      github.event_name == 'status'
    
    steps:
      - name: Check if PR is mergeable
        id: check-mergeable
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # If event is not from a PR, try to find PR from commit
          if [ -z "$PR_NUMBER" ]; then
            COMMIT_SHA="${{ github.event.check_suite.head_sha || github.sha }}"
            PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --json number,headRefOid --jq ".[] | select(.headRefOid == \"$COMMIT_SHA\") | .number" | head -1)
          fi
          
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found, skipping"
            exit 0
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          # Get PR details
          PR_JSON=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json mergeable,mergeStateStatus,isDraft,reviewDecision)
          
          MERGEABLE=$(echo "$PR_JSON" | jq -r '.mergeable')
          MERGE_STATE=$(echo "$PR_JSON" | jq -r '.mergeStateStatus')
          IS_DRAFT=$(echo "$PR_JSON" | jq -r '.isDraft')
          REVIEW_DECISION=$(echo "$PR_JSON" | jq -r '.reviewDecision // "NONE"')
          
          echo "PR #$PR_NUMBER status:"
          echo "  Mergeable: $MERGEABLE"
          echo "  Merge State: $MERGE_STATE"
          echo "  Is Draft: $IS_DRAFT"
          echo "  Review Decision: $REVIEW_DECISION"
          
          # Check if PR is ready to merge
          if [ "$MERGEABLE" = "MERGEABLE" ] && \
             [ "$MERGE_STATE" = "CLEAN" ] && \
             [ "$IS_DRAFT" = "false" ]; then
            echo "can_merge=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR is ready to merge"
          else
            echo "can_merge=false" >> $GITHUB_OUTPUT
            echo "‚è≥ PR is not ready to merge yet"
          fi

      - name: Auto-merge PR
        if: steps.check-mergeable.outputs.can_merge == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.check-mergeable.outputs.pr_number }}"
          
          echo "üîÑ Auto-merging PR #$PR_NUMBER..."
          
          # Merge the PR using squash merge (checks already verified as passing)
          gh pr merge $PR_NUMBER \
            --repo ${{ github.repository }} \
            --squash \
            --delete-branch || {
              echo "‚ùå Merge failed. PR may require manual intervention."
              echo "This could be due to:"
              echo "  - Additional branch protection rules"
              echo "  - Required reviewers not yet approved"
              echo "  - Insufficient permissions"
              exit 0
            }
          
          echo "‚úÖ PR #$PR_NUMBER merged successfully!"

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check-mergeable.outputs.can_merge }}" = "true" ]; then
            echo "‚úÖ PR merge process completed"
          else
            echo "‚ÑπÔ∏è PR not ready for merge or no PR found in this event"
          fi
