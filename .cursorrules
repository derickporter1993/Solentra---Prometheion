# Solentra Codebase Review System v2.0 — Cursor IDE Integration

## Salesforce Code Review Standards

When reviewing or writing Salesforce code in this project, apply these standards automatically.

### Auto-Fail Conditions (flag immediately)

1. **SOQL without CRUD/FLS**: Every SOQL query must use `WITH USER_MODE`. Flag `WITH SECURITY_ENFORCED` as outdated.
2. **DML without access control**: Every DML must use `as user` or `AccessLevel.USER_MODE`.
3. **SOQL/DML in loops**: Never place SOQL queries or DML statements inside `for`, `while`, or `do` loops.
4. **Hardcoded credentials**: No passwords, API keys, tokens, or secrets as string literals.
5. **Missing sharing keyword**: Every Apex class must declare `with sharing`, `inherited sharing`, or `without sharing`.
6. **SOQL injection**: Dynamic SOQL must use `Database.queryWithBinds()`, never string concatenation.
7. **Legacy assertions**: Use `Assert` class only. Never `System.assertEquals`, `System.assertNotEquals`, or `System.assert`.
8. **Legacy async**: Use Queueable only. Never `@future`.

### API Version

- All new code: API v66.0 (Spring '26)
- Flag any meta.xml with version below v58.0

### Apex Patterns

```apex
// SOQL — always WITH USER_MODE
List<Account> accts = [SELECT Id FROM Account WHERE Id = :someId WITH USER_MODE];

// DML — always as user
insert as user newRecords;
Database.insert(records, false, AccessLevel.USER_MODE);

// Dynamic SOQL — always queryWithBinds
Map<String, Object> binds = new Map<String, Object>{ 'status' => statusVal };
Database.queryWithBinds(query, binds, AccessLevel.USER_MODE);

// Null safety — prefer modern operators
String name = account.Name ?? 'Unknown';
String ownerName = record?.Owner?.Name ?? 'Unassigned';

// Error handling in @AuraEnabled
@AuraEnabled
public static Result doSomething() {
    try {
        // logic
    } catch (Exception e) {
        ElaroLogger.error('ClassName.method', e.getMessage(), e.getStackTraceString());
        throw new AuraHandledException('User-friendly message');
    }
}
```

### Sharing Model

- Controllers: `with sharing` (enforces record access)
- Services/Utilities: `inherited sharing` (inherits caller context)
- System operations: `without sharing` (MUST have `SECURITY:` comment explaining why)

### ApexDoc Requirements

Every class: `@author`, `@since`, `@group`. No `@description` tag.
Every public method: `@param`, `@return`, `@throws` where applicable.

### Test Standards

```apex
// Use Assert class only
Assert.areEqual(expected, actual, 'Descriptive message');
Assert.isTrue(condition, 'Why this should be true');
Assert.isNotNull(result, 'Result should exist');

// Always use Test.startTest/stopTest
Test.startTest();
// code under test
Test.stopTest();

// Flag fake assertions
// BAD: Assert.isTrue(true, 'works')
// BAD: Assert.areEqual(1, 1, 'match')
```

### LWC Standards

- Use `lwc:if` / `lwc:elseif` / `lwc:else`. Never `if:true` / `if:false`.
- All strings via Custom Labels: `import Label from '@salesforce/label/c.LabelName'`
- Every component handles: loading state, error state, empty state.
- SLDS for all styling. WCAG 2.1 AA compliance.

### Breaking Changes (v62.0+)

- v62.0: No Set modification during iteration
- v63.0: No JSON.serialize() on Exception objects
- v65.0: Abstract/override methods MUST have explicit access modifiers
- v66.0: Session IDs removed from outbound messages

### Logging

Use `ElaroLogger`, not `System.debug()`:
```apex
ElaroLogger.info('ClassName.method', 'What happened');
ElaroLogger.error('ClassName.method', e.getMessage(), e.getStackTraceString());
```

### CLI

Use `sf` commands only. `sfdx` was deprecated June 2024 and removed November 2024.

### Review State

Review findings are stored in `.review-state/` (gitignored). The multi-agent review system uses:
- `.review-state/state.json` — shared progress tracking
- `.review-state/security-findings.json` — Security Reviewer output
- `.review-state/governor-findings.json` — Governor Analyst output
- `.review-state/test-findings.json` — Test Auditor output
- `.review-state/architecture-findings.json` — Architecture Reviewer output
- `.review-state/appexchange-findings.json` — AppExchange Checker output
- `.review-state/final-report.md` — compiled final report
