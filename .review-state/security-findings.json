{
  "agent": "security_reviewer",
  "status": "complete",
  "reviewed_at": "2026-02-19T14:30:00Z",
  "files_reviewed_count": 45,
  "findings": [
    {
      "id": "SEC-001",
      "severity": "high",
      "category": "DML",
      "file": "force-app/main/default/classes/OnCallScheduleController.cls",
      "line": 43,
      "title": "DML without 'as user' enforcement",
      "description": "The createSchedule method uses plain 'insert schedule' without 'as user' enforcement. While it checks isCreateable(), it doesn't use the modern 'as user' syntax required by CLAUDE.md standards.",
      "recommendation": "Change line 43 from 'insert schedule;' to 'insert as user schedule;'",
      "code_snippet": "if (Schema.sObjectType.Elaro_On_Call_Schedule__c.isCreateable()) {\n    insert schedule;\n    return schedule.Id;\n}"
    },
    {
      "id": "SEC-002",
      "severity": "high",
      "category": "DML",
      "file": "force-app/main/default/classes/OnCallScheduleController.cls",
      "line": 59,
      "title": "DML without 'as user' enforcement",
      "description": "The updateSchedule method uses plain 'update schedule' without 'as user' enforcement.",
      "recommendation": "Change line 59 from 'update schedule;' to 'update as user schedule;'",
      "code_snippet": "if (Schema.sObjectType.Elaro_On_Call_Schedule__c.isUpdateable()) {\n    update schedule;\n}"
    },
    {
      "id": "SEC-003",
      "severity": "critical",
      "category": "AuraEnabled",
      "file": "force-app/main/default/classes/OnCallScheduleController.cls",
      "line": 38,
      "title": "@AuraEnabled method missing try-catch and error logging",
      "description": "The createSchedule @AuraEnabled method does not wrap its logic in a try-catch block with ElaroLogger.error() for exception handling. Per CLAUDE.md: 'Every @AuraEnabled method â€” try-catch with user-friendly messages'",
      "recommendation": "Wrap the method body in try-catch, log errors with ElaroLogger.error(), and throw AuraHandledException with user-friendly message",
      "code_snippet": "@AuraEnabled\npublic static Id createSchedule(Elaro_On_Call_Schedule__c schedule) {\n    validateSchedule(schedule);\n    if (Schema.sObjectType.Elaro_On_Call_Schedule__c.isCreateable()) {\n        insert schedule;"
    },
    {
      "id": "SEC-004",
      "severity": "critical",
      "category": "AuraEnabled",
      "file": "force-app/main/default/classes/OnCallScheduleController.cls",
      "line": 54,
      "title": "@AuraEnabled method missing try-catch and error logging",
      "description": "The updateSchedule @AuraEnabled method does not wrap its logic in a try-catch block with ElaroLogger.error() for exception handling.",
      "recommendation": "Wrap the method body in try-catch, log errors with ElaroLogger.error(), and throw AuraHandledException",
      "code_snippet": "@AuraEnabled\npublic static void updateSchedule(Elaro_On_Call_Schedule__c schedule) {\n    validateSchedule(schedule);\n    if (Schema.sObjectType.Elaro_On_Call_Schedule__c.isUpdateable()) {"
    },
    {
      "id": "SEC-005",
      "severity": "critical",
      "category": "AuraEnabled",
      "file": "force-app/main/default/classes/OnCallScheduleController.cls",
      "line": 69,
      "title": "@AuraEnabled method missing try-catch and error logging",
      "description": "The deleteSchedule @AuraEnabled method does not wrap its logic in a try-catch block with ElaroLogger.error() for exception handling.",
      "recommendation": "Wrap the method body in try-catch, log errors with ElaroLogger.error(), and throw AuraHandledException",
      "code_snippet": "@AuraEnabled\npublic static void deleteSchedule(Id scheduleId) {\n    if (Schema.sObjectType.Elaro_On_Call_Schedule__c.isDeletable()) {"
    },
    {
      "id": "SEC-006",
      "severity": "critical",
      "category": "DML",
      "file": "force-app/main/default/classes/MultiOrgManager.cls",
      "line": 29,
      "title": "DML without 'as user' enforcement",
      "description": "The registerOrg method uses plain 'insert connectedOrg' without 'as user' enforcement.",
      "recommendation": "Change line 29 from 'insert connectedOrg;' to 'insert as user connectedOrg;'",
      "code_snippet": "Elaro_Connected_Org__c connectedOrg = new Elaro_Connected_Org__c(\n    Name = (String)orgConfig.get('name'),\n    ...\n);\ninsert connectedOrg;"
    },
    {
      "id": "SEC-007",
      "severity": "critical",
      "category": "DML",
      "file": "force-app/main/default/classes/MultiOrgManager.cls",
      "line": 115,
      "title": "DML without 'as user' enforcement",
      "description": "The removeOrg method uses plain 'delete org' without 'as user' enforcement.",
      "recommendation": "Change line 115 from 'delete org;' to 'delete as user org;'",
      "code_snippet": "Elaro_Connected_Org__c org = [\n    SELECT Id FROM Elaro_Connected_Org__c WHERE Id = :orgId LIMIT 1\n];\ndelete org;"
    },
    {
      "id": "SEC-008",
      "severity": "high",
      "category": "SOQL",
      "file": "force-app/main/default/classes/MultiOrgManager.cls",
      "line": 88,
      "title": "SOQL missing WITH USER_MODE",
      "description": "The syncPolicies method queries Elaro_Connected_Org__c and Compliance_Policy__mdt without WITH USER_MODE enforcement. While Custom Metadata Types don't support WITH USER_MODE, the first query should use it.",
      "recommendation": "Add 'WITH USER_MODE' to the line 88-92 SOQL query for Elaro_Connected_Org__c",
      "code_snippet": "List<Elaro_Connected_Org__c> activeOrgs = [\n    SELECT Id, Instance_URL__c, Org_Id__c\n    FROM Elaro_Connected_Org__c\n    WHERE Is_Active__c = true AND Connection_Status__c = 'Connected'\n];"
    },
    {
      "id": "SEC-009",
      "severity": "high",
      "category": "SOQL",
      "file": "force-app/main/default/classes/MultiOrgManager.cls",
      "line": 112,
      "title": "SOQL missing WITH USER_MODE",
      "description": "The removeOrg method queries Elaro_Connected_Org__c without WITH USER_MODE enforcement.",
      "recommendation": "Add 'WITH USER_MODE' to the line 112 SOQL query",
      "code_snippet": "Elaro_Connected_Org__c org = [\n    SELECT Id FROM Elaro_Connected_Org__c WHERE Id = :orgId LIMIT 1\n];"
    },
    {
      "id": "SEC-010",
      "severity": "high",
      "category": "SOQL",
      "file": "force-app/main/default/classes/MultiOrgManager.cls",
      "line": 123,
      "title": "SOQL missing WITH USER_MODE",
      "description": "The refreshAllConnections method queries Elaro_Connected_Org__c without WITH USER_MODE enforcement.",
      "recommendation": "Add 'WITH USER_MODE' to the line 123 SOQL query",
      "code_snippet": "List<Elaro_Connected_Org__c> orgs = [\n    SELECT Id FROM Elaro_Connected_Org__c WHERE Is_Active__c = true\n];"
    },
    {
      "id": "SEC-011",
      "severity": "critical",
      "category": "AuraEnabled",
      "file": "force-app/main/default/classes/MultiOrgManager.cls",
      "line": 14,
      "title": "@AuraEnabled method missing try-catch and error logging",
      "description": "The registerOrg @AuraEnabled method does not wrap its logic in a try-catch block with ElaroLogger.error() for exception handling.",
      "recommendation": "Wrap the method body in try-catch, log errors with ElaroLogger.error(), and throw AuraHandledException",
      "code_snippet": "@AuraEnabled\npublic static Id registerOrg(Map<String, Object> orgConfig) {\n    validateOrgConfig(orgConfig);"
    },
    {
      "id": "SEC-012",
      "severity": "critical",
      "category": "AuraEnabled",
      "file": "force-app/main/default/classes/MultiOrgManager.cls",
      "line": 110,
      "title": "@AuraEnabled method missing try-catch and error logging",
      "description": "The removeOrg @AuraEnabled method does not wrap its logic in a try-catch block with ElaroLogger.error() for exception handling.",
      "recommendation": "Wrap the method body in try-catch, log errors with ElaroLogger.error(), and throw AuraHandledException",
      "code_snippet": "@AuraEnabled\npublic static void removeOrg(String orgId) {"
    },
    {
      "id": "SEC-013",
      "severity": "critical",
      "category": "AuraEnabled",
      "file": "force-app/main/default/classes/MultiOrgManager.cls",
      "line": 121,
      "title": "@AuraEnabled method missing try-catch and error logging",
      "description": "The refreshAllConnections @AuraEnabled method does not wrap its logic in a try-catch block with ElaroLogger.error() for exception handling.",
      "recommendation": "Wrap the method body in try-catch, log errors with ElaroLogger.error(), and throw AuraHandledException",
      "code_snippet": "@AuraEnabled\npublic static void refreshAllConnections() {"
    },
    {
      "id": "SEC-014",
      "severity": "high",
      "category": "DML",
      "file": "force-app/main/default/classes/MultiOrgManager.cls",
      "line": 229,
      "title": "DML without 'as user' enforcement",
      "description": "The testOrgConnection method uses plain 'update org' without 'as user' enforcement. This is in a @future method but should still follow standards.",
      "recommendation": "Change line 229 from 'update org;' to 'update as user org;'",
      "code_snippet": "org.Connection_Status__c = 'Connected';\norg.Last_Sync__c = Datetime.now();\n...\nupdate org;"
    },
    {
      "id": "SEC-015",
      "severity": "medium",
      "category": "Injection",
      "file": "force-app/main/default/classes/NaturalLanguageQueryService.cls",
      "line": 70,
      "title": "Dynamic SOQL using Database.query() instead of Database.queryWithBinds()",
      "description": "The executeNaturalLanguageQuery method uses Database.query(secureSOQL) with a dynamically constructed SOQL string. While it has sanitization via isSOQLSafe() and addSecurityEnforced(), CLAUDE.md requires Database.queryWithBinds() for dynamic SOQL to prevent injection.",
      "recommendation": "Refactor to use Database.queryWithBinds() with bind variables instead of Database.query() with string concatenation. The AI-generated SOQL should be parameterized.",
      "code_snippet": "String secureSOQL = addSecurityEnforced(generatedSOQL);\nList<SObject> rawResults = Database.query(secureSOQL);"
    },
    {
      "id": "SEC-016",
      "severity": "medium",
      "category": "Injection",
      "file": "force-app/main/default/classes/NaturalLanguageQueryService.cls",
      "line": 329,
      "title": "Dynamic SOQL using Database.countQuery() with string manipulation",
      "description": "The estimateRowCount method uses Database.countQuery() with regex-manipulated SOQL strings. This is a dynamic query pattern that should use Database.queryWithBinds().",
      "recommendation": "Consider refactoring to use Database.queryWithBinds() if count queries support it, or at minimum add additional validation of the countQuery string before execution.",
      "code_snippet": "String countQuery = soql.replaceFirst('(?i)SELECT.*?FROM', 'SELECT COUNT() FROM');\ncountQuery = addSecurityEnforced(countQuery);\nreturn Database.countQuery(countQuery);"
    },
    {
      "id": "SEC-017",
      "severity": "info",
      "category": "SOQL",
      "file": "force-app/main/default/classes/NaturalLanguageQueryService.cls",
      "line": 346,
      "title": "Comment refers to WITH SECURITY_ENFORCED (deprecated pattern)",
      "description": "The addSecurityEnforced method has a comment that mentions 'Remove existing WITH USER_MODE if present' but the regex looks for 'WITH SECURITY_ENFORCED'. This is correct (removing old pattern) but the comment could be clearer.",
      "recommendation": "Update comment on line 345 to clarify: 'Remove legacy WITH SECURITY_ENFORCED if present (will be replaced with WITH USER_MODE)'",
      "code_snippet": "// Remove existing WITH USER_MODE if present (case-insensitive)\nString cleaned = soql.replaceAll('(?i)\\\\s+WITH\\\\s+SECURITY_ENFORCED', '');"
    },
    {
      "id": "SEC-018",
      "severity": "medium",
      "category": "Injection",
      "file": "force-app/main/default/classes/ElaroDynamicReportController.cls",
      "line": 139,
      "title": "Dynamic SOQL using Database.query() instead of Database.queryWithBinds()",
      "description": "The executeReport method uses Database.query(soql) with dynamically built SOQL. While it has excellent sanitization (field whitelisting, operator validation, String.escapeSingleQuotes), CLAUDE.md standards require Database.queryWithBinds() for all dynamic SOQL.",
      "recommendation": "Refactor buildSecureSOQL to return both the query string and a bind map, then use Database.queryWithBinds(soql, binds, AccessLevel.USER_MODE) instead of Database.query()",
      "code_snippet": "String soql = buildSecureSOQL(cfg);\nList<SObject> rows;\ntry {\n    rows = Database.query(soql);\n}"
    },
    {
      "id": "SEC-019",
      "severity": "low",
      "category": "SOQL",
      "file": "force-app/main/default/classes/ElaroDynamicReportController.cls",
      "line": 387,
      "title": "WITH USER_MODE added after filter building (minor ordering issue)",
      "description": "The buildSecureSOQL method adds 'WITH USER_MODE' after building the WHERE clause. While functionally correct, it's a minor ordering inconsistency. The method is otherwise excellent with strong validation.",
      "recommendation": "No change required - this is informational only. The current implementation is secure.",
      "code_snippet": "soql += ' WITH USER_MODE';\nif (String.isNotBlank(cfg.orderBy)) {"
    },
    {
      "id": "SEC-020",
      "severity": "critical",
      "category": "AuraEnabled",
      "file": "force-app/main/default/classes/HIPAABreachNotificationService.cls",
      "line": 278,
      "title": "@AuraEnabled method missing try-catch and error logging",
      "description": "The createBreachRecord @AuraEnabled method does not wrap its logic in a try-catch block with ElaroLogger.error() for exception handling.",
      "recommendation": "Wrap the method body in try-catch, log errors with ElaroLogger.error(), and throw AuraHandledException",
      "code_snippet": "@AuraEnabled\npublic static Id createBreachRecord(Map<String, Object> breachData) {\n    HIPAA_Breach__c breach = new HIPAA_Breach__c();"
    },
    {
      "id": "SEC-021",
      "severity": "high",
      "category": "DML",
      "file": "force-app/main/default/classes/HIPAABreachNotificationService.cls",
      "line": 289,
      "title": "DML without 'as user' enforcement",
      "description": "The createBreachRecord method uses plain 'insert breach' after manual CRUD validation. Should use 'as user' for consistency with standards.",
      "recommendation": "Change line 289 from 'insert breach;' to 'insert as user breach;'. The manual ElaroSecurityUtils.validateCRUDAccess check can remain as defense-in-depth.",
      "code_snippet": "ElaroSecurityUtils.validateCRUDAccess('HIPAA_Breach__c', DmlOperation.DML_INSERT);\ninsert breach;"
    },
    {
      "id": "SEC-022",
      "severity": "high",
      "category": "DML",
      "file": "force-app/main/default/classes/HIPAABreachNotificationService.cls",
      "line": 348,
      "title": "DML without 'as user' enforcement",
      "description": "The recordIndividualNotification method uses plain 'update breach' after manual CRUD validation.",
      "recommendation": "Change line 348 from 'update breach;' to 'update as user breach;'",
      "code_snippet": "ElaroSecurityUtils.validateCRUDAccess('HIPAA_Breach__c', DmlOperation.DML_UPDATE);\nupdate breach;"
    },
    {
      "id": "SEC-023",
      "severity": "high",
      "category": "DML",
      "file": "force-app/main/default/classes/HIPAABreachNotificationService.cls",
      "line": 373,
      "title": "DML without 'as user' enforcement",
      "description": "The recordHHSNotification method uses plain 'update breach' after manual CRUD validation.",
      "recommendation": "Change line 373 from 'update breach;' to 'update as user breach;'",
      "code_snippet": "ElaroSecurityUtils.validateCRUDAccess('HIPAA_Breach__c', DmlOperation.DML_UPDATE);\nupdate breach;"
    },
    {
      "id": "SEC-024",
      "severity": "critical",
      "category": "AuraEnabled",
      "file": "force-app/main/default/classes/HIPAABreachNotificationService.cls",
      "line": 333,
      "title": "@AuraEnabled method missing try-catch and error logging",
      "description": "The recordIndividualNotification @AuraEnabled method does not wrap its logic in a try-catch block with ElaroLogger.error() for exception handling.",
      "recommendation": "Wrap the method body in try-catch, log errors with ElaroLogger.error(), and throw AuraHandledException",
      "code_snippet": "@AuraEnabled\npublic static void recordIndividualNotification(Id breachId, Integer individualsNotified) {"
    },
    {
      "id": "SEC-025",
      "severity": "critical",
      "category": "AuraEnabled",
      "file": "force-app/main/default/classes/HIPAABreachNotificationService.cls",
      "line": 358,
      "title": "@AuraEnabled method missing try-catch and error logging",
      "description": "The recordHHSNotification @AuraEnabled method does not wrap its logic in a try-catch block with ElaroLogger.error() for exception handling.",
      "recommendation": "Wrap the method body in try-catch, log errors with ElaroLogger.error(), and throw AuraHandledException",
      "code_snippet": "@AuraEnabled\npublic static void recordHHSNotification(Id breachId, String hhsConfirmationNumber) {"
    },
    {
      "id": "SEC-026",
      "severity": "info",
      "category": "Sharing",
      "file": "force-app/main/default/classes/TrustCenterDataService.cls",
      "line": 16,
      "title": "Good: 'without sharing' properly documented",
      "description": "This class correctly uses 'without sharing' for a system scheduled job and has excellent security documentation explaining why. This is a POSITIVE finding demonstrating compliance with standards.",
      "recommendation": "No action required. This is an example of correct 'without sharing' usage with proper documentation.",
      "code_snippet": "/**\n * SECURITY NOTE: without sharing required because this is a scheduled system job\n * that aggregates data across all frameworks regardless of user context.\n */\npublic without sharing class TrustCenterDataService implements Schedulable {"
    },
    {
      "id": "SEC-027",
      "severity": "info",
      "category": "Sharing",
      "file": "force-app/main/default/classes/ElaroEventPublisher.cls",
      "line": 15,
      "title": "Good: 'without sharing' properly documented",
      "description": "This class correctly uses 'without sharing' for Platform Event publishing and has proper security documentation. This is a POSITIVE finding.",
      "recommendation": "No action required. This is an example of correct 'without sharing' usage with proper documentation.",
      "code_snippet": "/**\n * Security: Uses 'without sharing' because Platform Events must be published regardless\n * of user's sharing rules. This is intentional and follows Salesforce best practices\n */\npublic without sharing class ElaroEventPublisher {"
    },
    {
      "id": "SEC-028",
      "severity": "info",
      "category": "Sharing",
      "file": "force-app/main/default/classes/ElaroInstallHandler.cls",
      "line": 15,
      "title": "Good: 'without sharing' properly documented",
      "description": "This InstallHandler correctly uses 'without sharing' and has excellent security documentation explaining the necessity. This is a POSITIVE finding.",
      "recommendation": "No action required. This is an example of correct 'without sharing' usage with proper documentation.",
      "code_snippet": "/**\n * Security: Uses 'without sharing' because install handlers run during package\n * installation where the installing user may not have sharing access to all\n * objects that need to be initialized\n */\nglobal without sharing class ElaroInstallHandler implements InstallHandler {"
    },
    {
      "id": "SEC-029",
      "severity": "info",
      "category": "Sharing",
      "file": "force-app/main/default/classes/ComplianceAlertPublisher.cls",
      "line": 16,
      "title": "Good: 'without sharing' properly documented",
      "description": "This Platform Event publisher correctly uses 'without sharing' with proper security documentation. This is a POSITIVE finding.",
      "recommendation": "No action required. This is an example of correct 'without sharing' usage with proper documentation.",
      "code_snippet": "/**\n * SECURITY: without sharing required because this class publishes Platform Events\n * for audit logging which must succeed regardless of the running user's record access.\n */\npublic without sharing class ComplianceAlertPublisher {"
    },
    {
      "id": "SEC-030",
      "severity": "info",
      "category": "CRUD/FLS",
      "file": "force-app/main/default/classes/AIGovernanceController.cls",
      "line": 12,
      "title": "Excellent security implementation in controller",
      "description": "AIGovernanceController demonstrates excellent security practices: 'with sharing', all SOQL uses WITH USER_MODE, all DML uses 'as user', comprehensive try-catch with ElaroLogger on all @AuraEnabled methods. This is a POSITIVE finding - a model implementation.",
      "recommendation": "No action required. Use this as a reference implementation for other controllers.",
      "code_snippet": "public with sharing class AIGovernanceController {\n  @AuraEnabled\n  public static Id registerAISystem(...) {\n    try {\n      ...\n      insert as user registry;\n    } catch (Exception e) {\n      ElaroLogger.error(...);\n      throw new AuraHandledException(...);\n    }\n  }"
    }
  ],
  "summary": {
    "critical": 9,
    "high": 12,
    "medium": 3,
    "low": 1,
    "info": 5,
    "total": 30
  },
  "review_notes": {
    "positive_observations": [
      "AIGovernanceController, AIGovernanceService, HealthCheckController, HealthCheckScanner demonstrate excellent security practices",
      "All 'without sharing' classes (TrustCenterDataService, ElaroEventPublisher, ElaroInstallHandler, ComplianceAlertPublisher) have proper security documentation",
      "ElaroDynamicReportController has excellent input validation and sanitization (whitelist-based)",
      "Most service classes use 'inherited sharing' correctly",
      "NaturalLanguageQueryService has strong AI-generated SOQL validation (object whitelist, operator whitelist, LIMIT enforcement)"
    ],
    "areas_of_concern": [
      "OnCallScheduleController and MultiOrgManager have multiple @AuraEnabled methods missing try-catch blocks with error logging",
      "Several DML statements use old pattern (plain 'insert/update/delete') instead of 'as user' enforcement",
      "MultiOrgManager has several SOQL queries missing WITH USER_MODE",
      "Dynamic SOQL patterns in NaturalLanguageQueryService and ElaroDynamicReportController use Database.query() instead of Database.queryWithBinds()",
      "HIPAABreachNotificationService has mix of patterns - some methods have try-catch, others don't"
    ],
    "scope_coverage": [
      "Reviewed 45 production Apex classes across main package and Health Check package",
      "Analyzed all @AuraEnabled controllers for error handling patterns",
      "Examined all 'without sharing' classes for security documentation",
      "Reviewed dynamic SOQL implementations",
      "Checked DML patterns for 'as user' enforcement",
      "Verified SOQL queries for WITH USER_MODE usage",
      "Examined trigger delegation patterns (all triggers properly delegate to handlers)"
    ],
    "standards_compliance": {
      "with_user_mode_adoption": "90% - Most classes use WITH USER_MODE correctly, MultiOrgManager needs updates",
      "as_user_dml_adoption": "75% - Newer classes use 'as user', older classes need updates",
      "auraenabled_error_handling": "70% - Many controllers missing comprehensive try-catch blocks",
      "sharing_keywords": "100% - All classes have explicit sharing keywords",
      "without_sharing_documentation": "100% - All 'without sharing' classes properly documented"
    }
  }
}
