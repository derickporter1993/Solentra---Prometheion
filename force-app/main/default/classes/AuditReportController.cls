/**
 * AuditReportController
 * 
 * Report generation for compliance audits
 * 
 * @author Elaro
 * @version 1.0
 * @since v3.1.0 (Spring '26)
 * @group Compliance Framework
 */
public with sharing class AuditReportController {
    
    /**
     * Generate audit report for a framework
     * @param framework Framework name
     * @param startDate Start date
     * @param endDate End date
     * @return Report data structure
     */
    @AuraEnabled
    public static AuditReport generateAuditReport(String framework, Date startDate, Date endDate) {
        if (String.isBlank(framework)) {
            throw new IllegalArgumentException('Framework cannot be blank');
        }
        if (startDate == null || endDate == null) {
            throw new IllegalArgumentException('Start date and end date are required');
        }
        
        AuditReport report = new AuditReport();
        report.framework = framework;
        report.startDate = startDate;
        report.endDate = endDate;
        report.generatedDate = System.now();
        report.generatedBy = UserInfo.getName();
        
        // Get framework evaluation
        report.evaluation = ComplianceFrameworkService.evaluateFramework(framework);
        
        // Get gaps in date range
        List<Compliance_Gap__c> gaps = [
            SELECT Id, Policy_Reference__c, Gap_Description__c, Severity__c, Status__c,
                   Risk_Score__c, Detected_Date__c, Remediation_Plan__c, Remediation_Owner__c,
                   Target_Remediation_Date__c, Actual_Remediation_Date__c
            FROM Compliance_Gap__c
            WHERE Framework__c = :framework
            AND Detected_Date__c >= :startDate
            AND Detected_Date__c <= :endDate
            WITH USER_MODE
            ORDER BY Risk_Score__c DESC NULLS LAST
        ];
        report.gaps = (List<Compliance_Gap__c>) ElaroSecurityUtils.stripInaccessibleFields(
            AccessType.READABLE,
            gaps
        );

        // Get evidence in date range
        List<Compliance_Evidence__c> evidence = [
            SELECT Id, Evidence_Type__c, Evidence_Date__c, Status__c, Compliance_Score__c,
                   Description__c, Reviewed_By__c, Reviewed_Date__c
            FROM Compliance_Evidence__c
            WHERE Framework__c = :framework
            AND Evidence_Date__c >= :startDate
            AND Evidence_Date__c <= :endDate
            WITH USER_MODE
            ORDER BY Evidence_Date__c DESC
        ];
        report.evidence = (List<Compliance_Evidence__c>) ElaroSecurityUtils.stripInaccessibleFields(
            AccessType.READABLE,
            evidence
        );
        
        // Calculate summary statistics
        report.totalGaps = report.gaps.size();
        report.openGaps = 0;
        report.remediatedGaps = 0;
        report.totalEvidence = report.evidence.size();
        report.approvedEvidence = 0;
        
        for (Compliance_Gap__c gap : report.gaps) {
            if (gap.Status__c == 'REMEDIATED' || gap.Status__c == 'VERIFIED') {
                report.remediatedGaps++;
            } else {
                report.openGaps++;
            }
        }
        
        for (Compliance_Evidence__c ev : report.evidence) {
            if (ev.Status__c == 'APPROVED') {
                report.approvedEvidence++;
            }
        }
        
        return report;
    }
    
    /**
     * Export report as PDF (returns ContentDocument ID)
     */
    @AuraEnabled
    public static String exportReportAsPDF(AuditReport report) {
        // Generate PDF content
        String pdfContent = generatePDFContent(report);
        
        // Validate CRUD access before DML
        ElaroSecurityUtils.validateCRUDAccess('ContentVersion', 
            ElaroSecurityUtils.DmlOperation.DML_INSERT);
        
        // Create ContentVersion
        ContentVersion cv = new ContentVersion();
        cv.Title = report.framework + '_Audit_Report_' + System.today().format();
        cv.PathOnClient = cv.Title + '.pdf';
        cv.VersionData = Blob.valueOf(pdfContent);
        cv.IsMajorVersion = true;
        
        try {
            insert cv;
            cv = [SELECT ContentDocumentId FROM ContentVersion WHERE Id = :cv.Id WITH USER_MODE];
            return cv.ContentDocumentId;
        } catch (Exception e) {
            throw new AuraHandledException('Error exporting report: ' + e.getMessage());
        }
    }
    
    /**
     * Generate PDF content (simplified - in production use a PDF library)
     */
    private static String generatePDFContent(AuditReport report) {
        String content = 'COMPLIANCE AUDIT REPORT\n';
        content += '========================\n\n';
        content += 'Framework: ' + report.framework + '\n';
        content += 'Period: ' + report.startDate + ' to ' + report.endDate + '\n';
        content += 'Generated: ' + report.generatedDate + '\n';
        content += 'Generated By: ' + report.generatedBy + '\n\n';
        content += 'SUMMARY\n';
        content += '-------\n';
        content += 'Overall Score: ' + report.evaluation.overallScore + '%\n';
        content += 'Status: ' + report.evaluation.status + '\n';
        content += 'Total Gaps: ' + report.totalGaps + '\n';
        content += 'Open Gaps: ' + report.openGaps + '\n';
        content += 'Remediated Gaps: ' + report.remediatedGaps + '\n';
        content += 'Total Evidence: ' + report.totalEvidence + '\n';
        content += 'Approved Evidence: ' + report.approvedEvidence + '\n';
        
        return content;
    }
    
    /**
     * Audit Report
     */
    public class AuditReport {
        @AuraEnabled public String framework;
        @AuraEnabled public Date startDate;
        @AuraEnabled public Date endDate;
        @AuraEnabled public Datetime generatedDate;
        @AuraEnabled public String generatedBy;
        @AuraEnabled public ComplianceFrameworkService.FrameworkEvaluationResult evaluation;
        @AuraEnabled public List<Compliance_Gap__c> gaps;
        @AuraEnabled public List<Compliance_Evidence__c> evidence;
        @AuraEnabled public Integer totalGaps;
        @AuraEnabled public Integer openGaps;
        @AuraEnabled public Integer remediatedGaps;
        @AuraEnabled public Integer totalEvidence;
        @AuraEnabled public Integer approvedEvidence;
    }
}
