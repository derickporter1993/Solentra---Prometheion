<template>
  <div class="prometheion-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
      <div class="header-left">
        <div class="logo-mark">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <path d="M12 2L2 7L12 12L22 7L12 2Z" />
            <path d="M2 17L12 22L22 17" />
            <path d="M2 12L12 17L22 12" />
          </svg>
        </div>
        <div class="header-titles">
          <h1>Compliance Dashboard</h1>
          <span class="last-updated">Last updated: {formattedLastUpdate}</span>
        </div>
      </div>
      <div class="header-actions">
        <button
          class="refresh-btn"
          onclick={refreshData}
          disabled={isLoading}
          aria-label="Refresh dashboard data"
          title="Refresh dashboard data"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            class={refreshIconClass}
            aria-hidden="true"
          >
            <path d="M23 4V10H17M1 20V14H7" />
            <path
              d="M3.51 9C4.01717 7.56678 4.87913 6.2854 6.01547 5.27542C7.15182 4.26543 8.52547 3.55976 10.0083 3.22426C11.4911 2.88875 13.0348 2.93434 14.4952 3.35677C15.9556 3.77921 17.2853 4.56471 18.36 5.64L23 10M1 14L5.64 18.36C6.71475 19.4353 8.04437 20.2208 9.50481 20.6432C10.9652 21.0657 12.5089 21.1112 13.9917 20.7757C15.4745 20.4402 16.8482 19.7346 17.9845 18.7246C19.1209 17.7146 19.9828 16.4332 20.49 15"
            />
          </svg>
          Refresh
        </button>
      </div>
    </div>

    <!-- Main Score Card -->
    <div class="main-score-section">
      <div class="score-ring-container">
        <div class="score-ring" style={scoreRingStyle}>
          <div class="score-inner">
            <span class="score-value">{displayScore}</span>
            <span class="score-label">Overall Score</span>
          </div>
        </div>
        <div class="score-rating">
          <span class={ratingBadgeClass}>{rating}</span>
        </div>
      </div>

      <!-- Framework Scores -->
      <div class="framework-scores">
        <div class="framework-header-section">
          <h2 class="section-title">Framework Compliance</h2>
          <lightning-combobox
            label="Filter by Framework"
            value={selectedFramework}
            options={frameworkOptions}
            onchange={handleFrameworkFilter}
            class="framework-filter"
          ></lightning-combobox>
        </div>
        <template lwc:if={showDrillDown}>
          <div class="drill-down-view">
            <button
              class="back-button"
              onclick={handleBackToAll}
              aria-label="Back to all frameworks view"
              title="Back to all frameworks view"
            >
              ← Back to All Frameworks
            </button>
            <template lwc:if={selectedFrameworkDetails}>
              <div class="framework-detail-card">
                <h3>{selectedFrameworkDetails.name}</h3>
                <p class="framework-description">{selectedFrameworkDetails.description}</p>
                <div class="framework-score-large">
                  <span class="score-value-large">{selectedFrameworkDetails.score}%</span>
                  <span class="score-label-large">Compliance Score</span>
                </div>
                <div class="progress-bar-large">
                  <div
                    class="progress-fill-large"
                    style={selectedFrameworkDetails.progressStyle}
                  ></div>
                </div>
              </div>
            </template>
          </div>
        </template>
        <template lwc:if={showFrameworkGrid}>
          <div class="framework-grid">
            <template for:each={frameworkList} for:item="fw">
              <div
                key={fw.name}
                class="framework-card"
                data-framework={fw.key}
                onclick={handleFrameworkClick}
              >
                <div class="framework-header">
                  <span class="framework-name">{fw.name}</span>
                  <span class={fw.scoreClass}>{fw.score}%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" style={fw.progressStyle}></div>
                </div>
                <p class="framework-description-small">{fw.description}</p>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>

    <!-- Score Factors -->
    <div class="factors-section">
      <h2 class="section-title">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
        >
          <path d="M12 20V10M18 20V4M6 20V16" />
        </svg>
        Score Breakdown
      </h2>
      <div class="factors-grid">
        <template for:each={factors} for:item="factor">
          <div key={factor.name} class="factor-card">
            <div class="factor-header">
              <span class="factor-name">{factor.name}</span>
              <span class={factor.statusClass}>{factor.status}</span>
            </div>
            <div class="factor-score">
              <span class="factor-value">{factor.score}</span>
              <span class="factor-max">/100</span>
            </div>
            <div class="factor-bar">
              <div class="factor-fill" style={factor.barStyle}></div>
            </div>
            <p class="factor-detail">{factor.detail}</p>
            <div class="factor-weight">
              <span>Weight: {factor.weightPercent}%</span>
              <span>Contribution: {factor.weightedScore}</span>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Top Risks -->
    <template lwc:if={hasRisks}>
      <div class="risks-section">
        <h2 class="section-title">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <path
              d="M10.29 3.86L1.82 18C1.64 18.3 1.55 18.64 1.55 19C1.55 19.36 1.64 19.7 1.82 20C2 20.3 2.26 20.55 2.57 20.73C2.88 20.91 3.24 21 3.6 21H20.4C20.76 21 21.12 20.91 21.43 20.73C21.74 20.55 22 20.3 22.18 20C22.36 19.7 22.45 19.36 22.45 19C22.45 18.64 22.36 18.3 22.18 18L13.71 3.86C13.53 3.56 13.27 3.32 12.96 3.15C12.65 2.98 12.3 2.89 11.95 2.89C11.6 2.89 11.25 2.98 10.94 3.15C10.63 3.32 10.37 3.56 10.19 3.86H10.29Z"
            />
            <path d="M12 9V13M12 17H12.01" />
          </svg>
          Top Risks
        </h2>
        <div class="risks-list">
          <template for:each={filteredTopRisks} for:item="risk">
            <div key={risk.nodeId} class="risk-card">
              <div class="risk-severity" data-severity={risk.severity}>
                <span class={risk.severityClass}>{risk.severity}</span>
              </div>
              <div class="risk-content">
                <h3 class="risk-title">{risk.title}</h3>
                <p class="risk-description">{risk.description}</p>
                <div class="risk-meta">
                  <span class="risk-framework">{risk.framework}</span>
                  <button
                    class="risk-action"
                    data-node-id={risk.nodeId}
                    onclick={handleRiskClick}
                    aria-label={risk.viewDetailsLabel}
                    title={risk.viewDetailsLabel}
                  >
                    View Details →
                  </button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- Audit Packages Section -->
    <template lwc:if={hasAuditPackages}>
      <div class="audit-packages-section">
        <h2 class="section-title">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <path
              d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z"
            />
            <path d="M14 2V8H20" />
          </svg>
          Recent Audit Packages
        </h2>
        <div class="audit-packages-list">
          <template for:each={formattedAuditPackages} for:item="pkg">
            <div
              key={pkg.id}
              class="audit-package-card"
              data-package-id={pkg.id}
              onclick={handleAuditPackageClick}
            >
              <div class="package-header">
                <span class="package-name">{pkg.packageName}</span>
                <span class="package-status status-{pkg.status.toLowerCase()}">{pkg.status}</span>
              </div>
              <div class="package-meta">
                <span class="package-framework">{pkg.framework}</span>
                <span class="package-period">
                  {pkg.formattedPeriodStart} - {pkg.formattedPeriodEnd}
                </span>
              </div>
              <div class="package-footer">
                <span class="package-created">Created: {pkg.formattedCreatedDate}</span>
                <span class="package-created-by" lwc:if={pkg.createdBy}>by {pkg.createdBy}</span>
              </div>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- Quick Actions -->
    <div class="actions-section">
      <button
        class="action-btn primary"
        onclick={handleGenerateSoc2}
        aria-label="Generate SOC2 Report"
        title="Generate SOC2 Report"
      >
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
        >
          <path
            d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z"
          />
          <path d="M14 2V8H20" />
        </svg>
        Generate SOC2 Report
      </button>
      <button
        class="action-btn secondary"
        onclick={handleGenerateHipaa}
        aria-label="Generate HIPAA Report"
        title="Generate HIPAA Report"
      >
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
          role="img"
        >
          <path d="M12 22S20 18 20 12V5L12 2L4 5V12C4 18 12 22 12 22Z" />
        </svg>
        Generate HIPAA Report
      </button>
    </div>

    <!-- Loading Overlay -->
    <template lwc:if={isLoading}>
      <div class="loading-overlay">
        <div class="loading-spinner"></div>
        <span>Calculating compliance scores...</span>
      </div>
    </template>
  </div>
</template>
