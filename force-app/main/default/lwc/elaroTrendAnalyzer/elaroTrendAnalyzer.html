<template>
  <lightning-card title="Elaro Trend Analyzer" icon-name="custom:custom63">
    <div class="slds-p-around_medium">
      <template lwc:if={isLoading}>
        <div class="slds-is-relative slds-p-around_medium">
          <lightning-spinner alternative-text="Analyzing trends" size="medium"></lightning-spinner>
        </div>
      </template>

      <template lwc:if={hasError}>
        <div class="slds-text-color_error slds-p-around_medium" role="alert">
          <lightning-icon icon-name="utility:error" size="small" class="slds-m-right_x-small" aria-hidden="true"></lightning-icon>
          {errorMessage}
        </div>
      </template>

      <template lwc:if={notLoading}>
        <!-- Configuration -->
        <div class="slds-grid slds-gutters slds-m-bottom_medium">
          <div class="slds-col slds-size_1-of-4">
            <lightning-combobox
              label="Object"
              value={selectedObject}
              options={objectOptions}
              onchange={handleObjectChange}
            ></lightning-combobox>
          </div>
          <div class="slds-col slds-size_1-of-4">
            <lightning-combobox
              label="Date Field"
              value={dateField}
              options={dateFields}
              onchange={handleDateFieldChange}
            ></lightning-combobox>
          </div>
          <div class="slds-col slds-size_1-of-4">
            <lightning-combobox
              label="Metric Field"
              value={metricField}
              options={metricFields}
              onchange={handleMetricFieldChange}
            ></lightning-combobox>
          </div>
          <div class="slds-col slds-size_1-of-4">
            <lightning-combobox
              label="Granularity"
              value={granularity}
              options={granularityOptions}
              onchange={handleGranularityChange}
            ></lightning-combobox>
          </div>
        </div>

        <div class="slds-m-bottom_medium">
          <lightning-input
            type="number"
            label="Months Back"
            value={monthsBack}
            min="1"
            max="36"
            onchange={handleMonthsBackChange}
          ></lightning-input>
        </div>

        <lightning-button
          label="Analyze Trend"
          onclick={handleAnalyze}
          disabled={isButtonDisabled}
          variant="brand"
        ></lightning-button>

        <!-- Trend Chart Data -->
        <template lwc:if={hasResults}>
          <div class="slds-m-top_large" role="region" aria-label="Trend analysis results">
            <h3 class="slds-text-heading_small">Trend Analysis</h3>
            <div class="slds-text-body_regular slds-m-bottom_medium">
              <p>Total: {trendTotal}</p>
              <p>Average: {trendAverage}</p>
              <p>Trend Direction: {trendDirection}</p>
            </div>
            <div class="slds-m-top_medium">
              <table class="slds-table slds-table_bordered" role="table" aria-label="Trend data by period">
                <thead>
                  <tr>
                    <th scope="col">Period</th>
                    <th scope="col">Value</th>
                    <th scope="col">Change</th>
                    <th scope="col">% Change</th>
                  </tr>
                </thead>
                <tbody>
                  <template for:each={trendBuckets} for:item="bucket">
                    <tr key={bucket.bucketDate}>
                      <td>{bucket.bucketDate}</td>
                      <td>{bucket.metricValue}</td>
                      <td>{bucket.changeFromPrevious}</td>
                      <td>{bucket.percentChange}%</td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>
      </template>
    </div>
  </lightning-card>
</template>
