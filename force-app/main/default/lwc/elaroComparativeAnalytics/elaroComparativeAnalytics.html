<template>
  <lightning-card title="Elaro Comparative Analytics" icon-name="custom:custom63">
    <div class="slds-p-around_medium">
      <template lwc:if={isLoading}>
        <div class="slds-is-relative slds-p-around_medium">
          <lightning-spinner alternative-text="Generating matrix" size="medium"></lightning-spinner>
        </div>
      </template>

      <template lwc:if={hasError}>
        <div class="slds-text-color_error slds-p-around_medium" role="alert">
          <lightning-icon icon-name="utility:error" size="small" class="slds-m-right_x-small" aria-hidden="true"></lightning-icon>
          {errorMessage}
        </div>
      </template>

      <template lwc:if={notLoading}>
        <!-- Configuration Section -->
        <div class="slds-grid slds-gutters slds-m-bottom_medium">
          <div class="slds-col slds-size_1-of-3">
            <lightning-combobox
              label="Object"
              value={selectedObject}
              options={objectOptions}
              onchange={handleObjectChange}
            ></lightning-combobox>
          </div>
          <div class="slds-col slds-size_1-of-3">
            <lightning-combobox
              label="Row Field"
              value={rowField}
              options={dimensionFields}
              onchange={handleRowFieldChange}
            ></lightning-combobox>
          </div>
          <div class="slds-col slds-size_1-of-3">
            <lightning-combobox
              label="Column Field"
              value={columnField}
              options={dimensionFields}
              onchange={handleColumnFieldChange}
            ></lightning-combobox>
          </div>
        </div>

        <div class="slds-m-bottom_medium">
          <lightning-input
            label="Aggregate Expression (e.g., SUM(Amount))"
            value={aggregateExpression}
            onchange={handleAggregateChange}
          ></lightning-input>
        </div>

        <lightning-button
          label="Generate Matrix"
          onclick={handleGenerate}
          disabled={isButtonDisabled}
          variant="brand"
        ></lightning-button>

        <!-- Results Matrix -->
        <template lwc:if={hasResults}>
          <div class="slds-m-top_large" role="region" aria-label="Matrix results">
            <h3 class="slds-text-heading_small">Matrix Results</h3>
            <table class="slds-table slds-table_bordered slds-table_cell-buffer" role="table" aria-label="Comparative analytics matrix">
              <thead>
                <tr>
                  <th scope="col"></th>
                  <template for:each={matrixColumns} for:item="col">
                    <th key={col} scope="col">{col}</th>
                  </template>
                  <th scope="col">Total</th>
                </tr>
              </thead>
              <tbody>
                <template for:each={computedMatrixData} for:item="rowData">
                  <tr key={rowData.row}>
                    <th scope="row"><strong>{rowData.row}</strong></th>
                    <template for:each={rowData.cells} for:item="cell">
                      <td key={cell.col}>{cell.value}</td>
                    </template>
                    <td><strong>{rowData.total}</strong></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </template>
      </template>
    </div>
  </lightning-card>
</template>
