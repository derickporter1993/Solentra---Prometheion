<template>
  <lightning-card title="Prometheion Dynamic Report Builder" icon-name="custom:custom63">
    <div class="slds-var-p-around_medium">
      <!-- Object Selection -->
      <lightning-combobox
        label="Select Object"
        value={selectedObject}
        options={objectOptions}
        onchange={handleObjectChange}
        placeholder="Choose an object"
      >
      </lightning-combobox>

      <!-- Field Selection -->
      <template if:true={fieldsLoaded}>
        <div class="slds-var-m-top_medium">
          <lightning-dual-listbox
            label="Select Fields"
            source-label="Available Fields"
            selected-label="Selected Fields"
            options={availableFields}
            value={selectedFields}
            onchange={handleFieldChange}
            min="1"
            max="20"
          >
          </lightning-dual-listbox>
        </div>
      </template>

      <!-- Filters Section -->
      <template if:true={showFilters}>
        <div class="slds-var-m-top_medium">
          <h3 class="slds-text-heading_small">Filters</h3>
          <template for:each={filters} for:item="filter">
            <div key={filter.id} class="slds-grid slds-gutters slds-var-m-top_small">
              <div class="slds-col slds-size_1-of-4">
                <lightning-combobox
                  label="Field"
                  value={filter.field}
                  options={filterableFields}
                  onchange={handleFilterFieldChange}
                  data-filter-id={filter.id}
                >
                </lightning-combobox>
              </div>
              <div class="slds-col slds-size_1-of-4">
                <lightning-combobox
                  label="Operator"
                  value={filter.operator}
                  options={operatorOptions}
                  onchange={handleFilterOperatorChange}
                  data-filter-id={filter.id}
                >
                </lightning-combobox>
              </div>
              <div class="slds-col slds-size_1-of-3">
                <lightning-input
                  label="Value"
                  value={filter.value}
                  onchange={handleFilterValueChange}
                  data-filter-id={filter.id}
                >
                </lightning-input>
              </div>
              <div class="slds-col slds-size_1-of-12">
                <lightning-button-icon
                  icon-name="utility:delete"
                  alternative-text="Remove filter"
                  onclick={handleRemoveFilter}
                  data-filter-id={filter.id}
                  class="slds-var-m-top_large"
                >
                </lightning-button-icon>
              </div>
            </div>
          </template>
          <lightning-button
            label="Add Filter"
            onclick={handleAddFilter}
            class="slds-var-m-top_small"
          >
          </lightning-button>
        </div>
      </template>

      <!-- Sort Options -->
      <template if:true={showSortOptions}>
        <div class="slds-var-m-top_medium">
          <div class="slds-grid slds-gutters">
            <div class="slds-col slds-size_1-of-2">
              <lightning-combobox
                label="Sort By"
                value={sortBy}
                options={sortableFields}
                onchange={handleSortByChange}
              >
              </lightning-combobox>
            </div>
            <div class="slds-col slds-size_1-of-2">
              <lightning-combobox
                label="Sort Direction"
                value={sortDirection}
                options={sortDirectionOptions}
                onchange={handleSortDirectionChange}
              >
              </lightning-combobox>
            </div>
          </div>
        </div>
      </template>

      <!-- Row Limit -->
      <div class="slds-var-m-top_medium">
        <lightning-input
          type="number"
          label="Maximum Rows"
          value={maxRows}
          min="1"
          max="10000"
          onchange={handleMaxRowsChange}
        >
        </lightning-input>
      </div>

      <!-- Action Buttons -->
      <div class="slds-var-m-top_large">
        <lightning-button
          variant="brand"
          label="Run Report"
          onclick={handleRunReport}
          disabled={isRunDisabled}
          class="slds-var-m-right_small"
        >
        </lightning-button>
        <lightning-button
          variant="neutral"
          label="Clear"
          onclick={handleClear}
          disabled={isLoading}
        >
        </lightning-button>
      </div>

      <!-- Results Section -->
      <template if:true={hasResults}>
        <div class="slds-var-m-top_large">
          <h3 class="slds-text-heading_small">Results ({recordCount} records)</h3>
          <lightning-datatable
            key-field="Id"
            data={reportData}
            columns={columns}
            hide-checkbox-column
            show-row-number-column
          >
          </lightning-datatable>
        </div>
      </template>

      <!-- Loading Spinner -->
      <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
      </template>

      <!-- Error Message -->
      <template if:true={hasError}>
        <div class="slds-var-m-top_medium">
          <lightning-alert variant="error" message={errorMessage}> </lightning-alert>
        </div>
      </template>
    </div>
  </lightning-card>
</template>
